import{_ as H,g as o,k as R,h as O,v as be,o as m,b as h,a as s,F as K,e as Q,n as xe,x as Ie,d as W,L as Z,r as J,p as ee,i as z,f as $,w as q,X as ke,E as k,T as $e,z as G,t as D,A as X,B as Y}from"./index-f50d6d08.js";import{_ as Se}from"./navbar.vue_vue_type_script_setup_true_lang-25a436aa.js";import{a as Te}from"./axios-a342f982.js";const Ce={class:"load-texture-container"},Ve={class:"inner"},je={__name:"LoadingText",setup(x){const d=o(new Array(7).fill(0)),i=o(!1),c=o(null);return R(i,l=>{if(l){let p=0;c.value=setInterval(()=>{d.value=d.value.map((r,v)=>2*Math.sin(p+2*Math.PI*((v+1)/8))),p++},100)}else clearInterval(c.value)}),O(()=>{i.value=!0}),be(()=>{i.value=!1}),(l,p)=>(m(),h("div",Ce,[s("div",Ve,[(m(!0),h(K,null,Q(d.value,(r,v)=>(m(),h("div",{key:v,class:"item",style:xe({transform:`translateY(${r}px)`})},null,4))),128))])]))}},Ue=H(je,[["__scopeId","data-v-32c6fbc2"]]);function Pe(){const x=navigator.userAgent,i=btoa(x).substring(0,10);return console.log(`生成的唯一 user ID 是：${i}`),i}const te=Ie("message",()=>{const x=o({name:"1.png"}),d=Pe(),i=o(d);return{select_reference_image:x,user_id:i}}),De={class:"main"},Re={class:"grid grid-cols-12 gap-2 p-2"},Oe=["src","onDblclick","onClick"],Le={class:"w-24 h-24 flex items-center justify-center text-gray-500"},Ne=["src"],Me=W({__name:"referenceImages",setup(x){const d=o("reference"),{select_reference_image:i}=Z(te()),c="https://ai.minitool.fun:15554",l=c+"/live/upload_file",p=o([]),r=o(""),v=o(!1);function u(n){console.log("选择图片：",n),i.value=n}const S=async n=>{console.log("开始更新上传后的文件列表，上传的文件是是:",n),await _()},y=n=>{console.log("点击图片预览：",n),r.value=n.url,v.value=!0};async function T(){try{return(await Te.post(c+"/live/list_reference",{})).data.data}catch(n){console.log(n),k({title:"Error",message:"处理元数据的接口请求失败"})}}async function _(){const n=await T();n&&(n.forEach(f=>{f.name=f.filename,f.url=c+"/"+f.filepath}),console.log(n),p.value=n)}return O(async()=>{await _()}),(n,f)=>{const w=J("el-upload"),C=J("el-dialog");return m(),h("div",De,[s("div",Re,[(m(!0),h(K,null,Q(p.value,(g,V)=>(m(),h("img",{key:V,src:g.url,alt:"item.name",class:ee(["w-24 h-24 object-cover cursor-pointer",{"outline-yellow-600 outline-4 outline-dashed":g.name===z(i).name}]),onDblclick:I=>y(g),onClick:I=>u(g)},null,42,Oe))),128)),$(w,{class:"flex justify-center items-center border-2 border-dashed border-gray-300 rounded-lg cursor-pointer",action:l,"show-file-list":!1,"auto-upload":!0,"on-change":S,data:{usage:d.value}},{default:q(()=>[s("div",Le,[$(z(ke),{class:"w-12 h-12"})])]),_:1},8,["data"])]),$(C,{modelValue:v.value,"onUpdate:modelValue":f[0]||(f[0]=g=>v.value=g)},{default:q(()=>[s("img",{class:"w-full",src:r.value,alt:"Preview Image"},null,8,Ne)]),_:1},8,["modelValue"])])}}});const Fe=H(Me,[["__scopeId","data-v-9217ef67"]]),Ae={class:"main"},Ee={key:0,class:"relative px-0 py-1.5"},Be={id:"webcamcontrols",class:"flex flex-col items-center mt-4"},Je=s("p",null,"选择一个头像或者上传1张，推荐录制一段体验和上传一个视频（图片），开启实时处理（实验中)",-1),ze={class:"flex flex-col md:flex-row md:gap-10 gap-4"},qe=["disabled"],Ge={key:0,class:"mt-2 text-sm text-gray-700"},Xe={class:"flex flex-col md:flex-row justify-between mt-6 space-y-4 md:space-y-0 md:space-x-4"},Ye={id:"serverVideoContainer",class:"w-full md:w-1/2"},He={id:"imageContainer",class:"w-full md:w-1/2"},Ze=W({__name:"recordFace",setup(x){const{select_reference_image:d,user_id:i}=Z(te()),c=o(!1),l="https://ai.minitool.fun:15554",p=o(null),r=o(null),v=o(null);let u=null,S=null;const y=o(!1),T=o("00:00");let _=null,n=null;const f=o(),w=o(!1),C=o(0),g=o(),V=o(null),I=o(null),L=o(!1),j=o(!0),U=o(!0),b=o("");R(b,e=>{e&&(U.value=!1)});function ae(){if(!b.value){console.error("下载地址无效");return}const e=document.createElement("a");e.href=b.value,e.download="",e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}const oe=()=>{V.value.click()},ne=e=>{const t=e.target.files;t.length>0&&(I.value=t[0],L.value=le(I.value),se())},se=async()=>{if(!I.value)return;const e=new FormData;e.append("file",I.value),e.append("user_id",i.value);try{const t=await fetch(`${l}/live/upload_file`,{method:"POST",body:e});if(!t.ok)throw new Error("上传失败");const a=await t.json();g.value=a.data.filepath,console.log("文件上传成功:",a)}catch(t){console.error("上传过程中出错:",t)}},le=e=>["image/jpeg","image/png","image/gif"].includes(e.type);R(g,async(e,t)=>{e&&(c.value=!0,L.value?(j.value=!1,await re()):(j.value=!0,await ie()),c.value=!1)});async function re(){try{const e=await fetch(`${l}/live/image_to_video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:i.value,source_filepath:d.value.name,target_filepath:g.value})});if(e.ok){const t=await e.json();if(console.log("图片的处理结果",t),t.code===0&&t.data&&t.data.output_path){const a=t.data.output_path;v.value&&(v.value.src=`${l}/${a}`,v.value.play()),b.value=`${l}/${a}`,k({title:"Success",message:"变身成功"})}else console.log("处理消息是:",t.msg)}else console.log("处理后的图片未完成")}catch(e){console.log("获取处理后图片时出错：",e)}}async function ie(){try{const e=await fetch(`${l}/live/image_to_video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:i.value,source_filepath:d.value.name,target_filepath:g.value})});if(e.ok){const t=await e.json();if(console.log("任务提交结果",t),t.code===0&&t.data&&t.data.output_path){const a=t.data.output_path;c.value=!0,await ce(a)}else console.log("任务提交消息是:",t.msg)}else console.log("提交任务时发生错误")}catch(e){console.log("提交任务时出错：",e)}}async function ce(e){let A=0;const E=setInterval(async()=>{try{const P=await fetch(`${l}/live/check_video_status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({output_path:e})});if(P.ok){const B=await P.json();B.code===0&&B.data.is_ready?(clearInterval(E),r.value&&(r.value.src=`${l}/${e}`,r.value.play()),b.value=`${l}/${e}`,k({title:"Success",message:"变身成功，点击播放按钮开始播放吧"}),c.value=!1):(console.log("视频尚未生成"),k({title:"Success",message:"视频尚未生成，请等待"}))}else console.log("检查视频状态时发生错误")}catch(P){console.log("检查视频状态时出错：",P)}A++,A>=60&&(clearInterval(E),console.log("任务超时，停止轮询"))},5e3)}const ue=async()=>{try{const t=await(await fetch(`${l}/live/get_live_video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:i.value,record_id:f.value,one_reference:d.value.name})})).json();if(console.log(t),t.data)k({title:"Success",message:"1个视频变身成功，更多视频正在进行中。。。"});else return alert("没有更多视频了，播放结束"),null;return l+"/"+t.data}catch(e){return console.error("获取视频地址失败:",e),null}},N=async()=>{if(r.value){const e=await ue();e?(console.log("下一视频 URL:",e),b.value=e,r.value.src=e,r.value.load(),r.value.onerror=t=>{console.error("视频加载错误:",t)},await r.value.play()):console.log("没有更多视频了。")}};function de(e){return new Promise(t=>setTimeout(t,e))}async function ve(){w.value?(await F(),w.value=!1,c.value=!1):(c.value=!0,w.value=!0,C.value=0,await M(),await de(6e3),r.value.addEventListener("ended",N),N())}function fe(e){console.log("webcam fail!",e)}function ge(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}async function pe(){y.value?(y.value=!1,await F(),he()):(y.value=!0,c.value=!0,await M())}async function M(){S?(T.value="00:00",ye(),f.value=`record${new Date().toISOString().slice(0,19).replace(/[-:T]/g,"")}`,u=new MediaRecorder(S),await new Promise((e,t)=>{u.onstart=()=>{console.log("开始录制"),e()},u.onerror=a=>{console.error("录制错误:",a),t(a)},u.start()}),u.ondataavailable=function(e){_e(e.data)},_=setInterval(()=>{u&&(u.stop(),u.onstop=()=>u.start())},2e3)):console.log("没有可用的摄像头流")}async function F(){u&&await new Promise((e,t)=>{u.onstop=()=>{console.log("录制结束"),e()},u.onerror=a=>{console.error("录制错误:",a),t(a)},u.stop()}),_&&(clearInterval(_),_=null)}async function _e(e){console.log("开始发送视频数据到服务器");const t=new FormData;if(t.append("video",e,"video.webm"),t.append("user_id",i.value),t.append("record_id",f.value),t.append("one_reference",d.value.name),w.value){if(t.append("live",!0),C.value>5&&Math.random()<.99){console.log("live模式，处理不过来，随机丢弃当前录制的视频");return}C.value+=1}try{(await fetch(`${l}/live/record_videos`,{method:"POST",body:t})).ok?console.log("视频数据发送到服务器完成"):console.log("视频发送失败")}catch(a){console.log("发送视频数据时出错：",a)}}async function me(){try{const e=await fetch(`${l}/live/get_fake_record_video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:i.value,record_id:f.value,one_reference:d.value.name})});if(e.ok){const t=await e.json();if(console.log("视频的处理结果",t),t.code===0&&t.data&&t.data.path){const a=t.data.path;r.value&&(r.value.src=`${l}/${a}`,r.value.play()),b.value=`${l}/${a}`,n&&(clearInterval(n),n=null),c.value=!1,k({title:"Success",message:"变身成功，点击播放按钮开始播放吧"})}else console.log("视频处理消息是:",t.msg)}else console.log("处理后的视频未完成")}catch(e){console.log("获取处理后视频时出错：",e)}}function he(){n=setInterval(()=>{me()},5e3)}function ye(){let e=0;_=setInterval(()=>{e++,T.value=we(e)},1e3)}function we(e){const t=Math.floor(e/60),a=e%60;return`${t.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}return O(()=>{ge()?navigator.mediaDevices.getUserMedia({audio:!0,video:{width:{ideal:1920},height:{ideal:1080}}}).then(e=>{p.value&&(p.value.srcObject=e),S=e}).catch(fe):alert("getUserMedia() is not supported in your browser")}),$e(()=>{n&&clearInterval(n),_&&clearInterval(_)}),(e,t)=>(m(),h("div",Ae,[$(Se),s("div",null,[$(Fe),c.value?(m(),h("div",Ee,[$(Ue)])):G("",!0),s("div",Be,[Je,s("div",ze,[s("button",{class:"recordbutton bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-200",onClick:pe},D(y.value?"停止录制":"录制一段体验"),1),s("button",{class:"recordbutton bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-200",onClick:ve},D(w.value?"停止实时处理":"开启实时处理"),1),s("div",null,[s("input",{type:"file",ref_key:"fileInput",ref:V,onChange:ne,style:{display:"none"}},null,544),s("button",{class:"bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-200",onClick:oe},"上传一个视频")]),s("button",{disabled:U.value,class:ee([{"bg-green-500 text-white hover:bg-green-600":!U.value,"bg-gray-300 text-gray-500 cursor-not-allowed":U.value},"recordbutton py-2 px-4 rounded transition duration-200"]),onClick:ae}," 下载结果 ",10,qe)]),y.value?(m(),h("div",Ge," 录制时长: "+D(T.value),1)):G("",!0)]),s("div",Xe,[s("video",{ref_key:"video",ref:p,class:"w-full md:w-1/2",autoplay:""},null,512),X(s("div",Ye,[s("video",{ref_key:"serverVideo",ref:r,class:"w-full",controls:"",autoplay:""},null,512)],512),[[Y,j.value]]),X(s("div",He,[s("img",{ref_key:"serverImg",ref:v,class:"w-full"},null,512)],512),[[Y,!j.value]])])])]))}});export{Ze as default};
