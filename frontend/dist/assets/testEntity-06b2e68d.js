import{d as pe,L as he,g as r,k as J,h as me,o as m,b as f,f as fe,a as e,F as B,e as A,A as D,M as K,t as _,B as Q,n as ve,j as W,U as S,E as y}from"./index-f50d6d08.js";import{a as ge,_ as we}from"./navHeader.vue_vue_type_script_setup_true_lang-5f81fcc5.js";import{d as xe}from"./api-e233926e.js";import{i as L}from"./index-cbf34b5d.js";import{a as be}from"./axios-a342f982.js";import{l as ye}from"./lodash-0e7c12dd.js";const ke=e("div",{class:"text-center text-3xl font-bold text-cyan-400"},"测试实体",-1),je={class:"text-gray-600 body-font"},Ce={class:"container px-3 pt-10 mx-auto flex flex-wrap"},Be={class:"flex flex-wrap w-full"},ze={class:"w-full md:pr-10 md:py-6"},Ee={class:"flex relative pb-12"},Me=S('<div class="h-full w-10 absolute inset-0 flex items-center justify-center"><div class="h-full w-1 bg-gray-200 pointer-events-none"></div></div><div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-500 inline-flex items-center justify-center text-white relative z-10"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg></div><div class="flex-grow pl-4"><h2 class="font-medium title-font text-sm text-gray-900 mb-1 tracking-wider">STEP 1</h2><p class="leading-relaxed">选择数据，输入prompt name，获取对应的数据集</p></div>',3),Ae={class:"flex flex-row items-center"},De=e("p",{class:"ml-4"},"选择渠道：",-1),Se=["value","name"],Ie={class:"hover:bg-gray-50 flex items-center justify-between px-3 py-1 border-2 rounded-lg cursor-pointer text-sm border-gray-200 group peer-checked:border-blue-500"},Ne={class:"font-medium text-gray-700"},Oe=e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-9 h-9 text-blue-600 invisible group-[.peer:checked+&]:visible"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),Ve={class:"text-center my-auto mx-2"},Le=e("span",null,"数据量:",-1),$e={class:"badge badge-lg"},Pe={class:"flex relative pb-12"},Fe=S('<div class="h-full w-10 absolute inset-0 flex items-center justify-center"><div class="h-full w-1 bg-gray-200 pointer-events-none"></div></div><div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-500 inline-flex items-center justify-center text-white relative z-10"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg></div><div class="flex-grow pl-4"><h2 class="font-medium title-font text-sm text-gray-900 mb-1 tracking-wider">STEP 2</h2><p class="leading-relaxed">选择模型，使用哪个模型进行预测</p></div>',3),Te={class:"flex flex-row items-center"},He=e("p",{class:"ml-4"},"模型：",-1),Ue=["value","name"],qe={class:"hover:bg-gray-50 flex items-center justify-between px-3 py-1 border-2 rounded-lg cursor-pointer text-sm border-gray-200 group peer-checked:border-blue-500"},Ge={class:"font-medium text-gray-700"},Re=e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-9 h-9 text-blue-600 invisible group-[.peer:checked+&]:visible"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),Ye={class:"text-center my-auto mx-2"},Je=S('<div class="h-full w-10 absolute inset-0 flex items-center justify-center"><div class="h-full w-1 bg-gray-200 pointer-events-none"></div></div><div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-500 inline-flex items-center justify-center text-white relative z-10"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div><div class="flex-grow pl-4"><h2 class="font-medium title-font text-sm text-gray-900 mb-1 tracking-wider">STEP 3</h2><p class="leading-relaxed">模型预测</p></div>',3),Ke={class:"flex relative"},Qe=S('<div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-500 inline-flex items-center justify-center text-white relative z-10"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path><path d="M22 4L12 14.01l-3-3"></path></svg></div><div class="flex-grow pl-4"><h2 class="font-medium title-font text-sm text-gray-900 mb-1 tracking-wider">FINISH</h2><p class="leading-relaxed">查看和分析结果.</p></div>',2),We={class:"flex flex-row items-center gap-5 mr-96"},Xe={class:"dropdown"},Ze={tabindex:"0",class:"dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52"},et=["onClick"],tt={class:"w-11/12 mx-auto"},st={class:"relative pt-1"},ot={class:"flex mb-2 items-center justify-between"},nt={class:"text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200"},at={class:"text-right"},lt={class:"text-xs font-semibold inline-block text-blue-600"},ct={class:"overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200"},it={class:"stats shadow mx-auto"},rt={class:"stat"},dt=e("div",{class:"stat-title"},"准确率",-1),ut={class:"stat-value"},_t={class:"stat"},pt=e("div",{class:"stat-title"},"正确预测结果数(一条评论有多个预测)",-1),ht={class:"stat-value"},mt={class:"stat"},ft=e("div",{class:"stat-title"},"错误数",-1),vt={class:"stat-value"},gt=e("div",{id:"accuracy-pie",class:"w-full h-96"},null,-1),wt=e("div",{id:"accuracy-category",class:"w-full h-96"},null,-1),xt=e("div",{id:"label-count",class:"w-full h-96"},null,-1),bt=e("div",{id:"predict-count",class:"w-full h-96"},null,-1),yt={class:"text-gray-600 body-font"},kt={class:"container px-5 py-24 mx-auto"},jt={class:"flex flex-wrap -m-4"},Ct={class:"p-4 md:w-1/2 w-full"},Bt={class:"h-full bg-gray-100 p-8 rounded"},zt={class:"leading-relaxed mb-6"},Et={class:"flex items-center"},Mt={class:"flex-grow flex flex-col pl-4"},At={class:"title-font font-medium text-gray-900 whitespace-pre-wrap"},Dt={class:"flex items-center mt-2"},St={class:"flex-grow flex flex-col pl-4"},It={class:"text-gray-500 text-sm whitespace-pre-wrap"},Tt=pe({__name:"testEntity",setup(Nt){const{usecache:X}=he(ge()),Z=r(["ceshi_shiti","shiti-ceshi2"]),z=r("ceshi_shiti"),v=r([]),$=r(0),P=r([]),F=r("Factory模型经过训练过的模型，经过训练了3个epoch"),T=r([{name:"Factory",description:"Factory模型经过训练过的模型，经过训练了3个epoch"},{name:"DocChat",description:"DocChat模型基于文档的问答模型，没有经过情感训练"},{name:"Yi34B",description:"Yi34B模型，但是参数量大，没有经过情感训练"},{name:"mtdnn",description:"传统的编码器模型"}]),k=r("mtdnn"),ee="https://ai.minitool.fun:6677",te="https://ai.minitool.fun:3326",E=r(!1),I=r(0),x=r(0),M=r(!1),H=r(0),U=r(0),q=r(0),G=r(!1),N=r([]),R=r([]),se=(s,o,t,a,c)=>{document.getElementById(s).setAttribute("_echarts_instance_","");var n=document.getElementById(s),l=L(n);const d={title:{text:c},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},legend:{},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"value",boundaryGap:[0,.01]},yAxis:{type:"category",data:o},series:[{name:"人工",type:"bar",data:t},{name:"预测",type:"bar",data:a}]};d&&l.setOption(d),window.onresize=()=>{l.resize()}};function O(){let s={},o=[];for(let t of v.value){const a=t.predict_answers,c=t.human_answers,n=t.id;console.log(a),console.log(c);for(let l of c){const d=l.subject,p=l.category,u=l.label;for(let i of a){const b=i.subject,g=i.category,w=i.label;if(b===d&&g===p&&w!==u){if(s[w]||(s[w]=[]),o.includes(n))continue;o.push(n),s[w].push(t),s[p]||(s[p]=[]),s[p].push(t)}}}}for(let t in s){const a=s[t].length;R.value.push({name:t,number:a})}return s}function oe(s){if(x.value!==100){y.warning({title:"警告",message:"请先进行预测，才能进行分析"});return}E.value=!1,M.value=!1;const o=O();if(o[s]){N.value=[],G.value=!0;for(let t of o[s]){const a=t.messages[0].content,c=t.predict_answers,n=t.messages[1].content;let l="";for(let p of c){const u=`(${p.subject} | ${p.category} | ${p.label})`;l+=u+`
`}const d={content:a,predict:l,human:n};N.value.push(d)}y.info({title:"成功",message:"请查看刷新后的样本"})}else y.warning({title:"警告",message:"您选择的类型没有错误样本"})}function ne(){if(x.value!==100){y.warning({title:"警告",message:"请先进行预测，才能进行分析"});return}y.info({title:"警告",message:"点击按钮2次，绘图就可以正常显示"}),M.value=!0,E.value=!1,G.value=!1;let s=0,o=0,t={是:[1,1],否:[1,1]},a={是:0,否:0},c={是:0,否:0},n={};for(let u of v.value){const i=u.predict_answers,b=u.human_answers;console.log(i),console.log(b);for(let g of b){const w=g.subject,h=g.category,j=g.label;a[j]+=1;for(let V of i){const ue=V.subject,_e=V.category,C=V.label;ue===w&&_e===h&&(C===j?(o+=1,t[C][0]+=1,n[h]||(n[h]=[0,0]),n[h][0]+=1,c[C]+=1):(s+=1,t[C][1]+=1,n[h]||(n[h]=[0,0]),n[h][1]+=1,c[C]+=1))}}}U.value=o,q.value=s,H.value=o/(o+s)*100,ae(t);const l=Object.values(n).map(u=>u[0]),d=Object.values(n).map(u=>u[1]),p=Object.keys(n);le(p,l,d),se("label-count",Object.keys(a),Object.values(a),Object.values(c),"人工和预测的标签数量对比")}const ae=s=>{document.getElementById("accuracy-pie").setAttribute("_echarts_instance_","");var o=document.getElementById("accuracy-pie"),t=L(o);const a={legend:{},tooltip:{},dataset:{source:[["product","是","否"],["正确",s.是[0],s.否[0]],["错误",s.是[1],s.否[1]]]},series:[{type:"pie",radius:"20%",center:["10%","50%"],encode:{itemName:"product",value:"是"},label:{show:!0,formatter:"{b}: ({d}%)"}},{type:"pie",radius:"20%",center:["50%","50%"],encode:{itemName:"product",value:"否"},label:{show:!0,formatter:"{b}: ({d}%)"}}],title:[{text:"是",left:"10%",top:"70%",textAlign:"center"},{text:"否",left:"50%",top:"70%",textAlign:"center"}]};a&&t.setOption(a),window.onresize=()=>{t.resize()}},le=(s,o,t)=>{document.getElementById("accuracy-category").setAttribute("_echarts_instance_","");var a=document.getElementById("accuracy-category"),c=L(a);const n={title:{text:"每个类别的预测结果的统计"},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},legend:{},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"value",boundaryGap:[0,.01]},yAxis:{type:"category",data:s},series:[{name:"正确",type:"bar",data:o},{name:"错误",type:"bar",data:t}]};n&&c.setOption(n),window.onresize=()=>{c.resize()}};async function ce(){E.value=!0,I.value=0;const s=new Date().getTime();for(let o in v.value){console.log("正在预测第",o,"条数据");const t=v.value[o],a=t.messages,{human_answers:c,comments:n}=re(a);if(c.length===0)continue;const l=await de(c,n);t.predict_answers=l,t.human_answers=c,v.value[o]=t,I.value=Math.round((new Date().getTime()-s)/1e3),x.value=Math.round(+o/v.value.length*100)}x.value=100,console.log("预测完成,预测结果是:",v.value),O()}async function ie(s){let o=ee;k.value==="mtdnn"&&(o=te);try{return(await be.post(o+"/api/foodentity",{data:s,model:k.value,usecache:X.value})).data.data}catch(t){console.log(t),y({title:"Error",message:"处理请求情感接口失败"})}}function re(s){let o=[];const t=s[0].content,a=s[1].content;if(a==="无")return{human_answers:o,comments:t};const c=a.split(`
`);for(let n of c){n=n.replace("，",","),n=n.replace("(","").replace(")","");const l=n.split(",").map(p=>p.trim());if(l.length!=3){console.warn("数据出现错误，该数据切分后应该有3个元素",n);continue}const d={subject:l[0],category:l[1],label:l[2]};o.push(d)}return o.sort((n,l)=>n.subject.localeCompare(l.subject)),{human_answers:o,comments:t}}async function de(s,o){let t=ye.cloneDeep(s);for(let n of t)n.label="是";const a=t.map(n=>n.category),c=Array.from(new Set(a));for(let n of c){const l=t.filter(i=>i.category===n);let d={};for(let i of l)i.category in d?d[i.category].push(i.subject):d[i.category]=[i.subject];const u=await ie({content:o,entity:d});console.log("实体判断结果:",u);for(let i in u){console.log("result[category]:",u[i]);for(let b of u[i]){const g=b.aspect,w=b.label,h=t.findIndex(j=>j.category===i&&j.subject===g);h!==-1?t[h].label=w:console.warn("预测结果中，找不到对应的主体和关系，无法修改情感，这是不对的:",i,g)}}}return console.log("实体判断的预测结果:",t),t}J(k,s=>{F.value=T.value.find(o=>o.name===s).description}),J(z,s=>{Y(),M.value=!1,x.value=0});function Y(){const s=z.value,o=P.value.filter(t=>t.prompt_name.includes(s));console.log(`根据channel为${s}获取到的数据数量为${o.length}`),v.value=o,$.value=o.length}return me(async()=>{const s=await xe({mode:"detail",limit:-1});P.value=s.data,Y()}),(s,o)=>(m(),f(B,null,[fe(we),e("div",null,[ke,e("section",je,[e("div",Ce,[e("div",Be,[e("div",ze,[e("div",Ee,[Me,e("div",Ae,[De,(m(!0),f(B,null,A(Z.value,t=>(m(),f("label",null,[D(e("input",{type:"radio",value:t,class:"peer hidden",name:t,"onUpdate:modelValue":o[0]||(o[0]=a=>z.value=a)},null,8,Se),[[K,z.value]]),e("div",Ie,[e("h2",Ne,_(t),1),Oe])]))),256))]),e("div",Ve,[Le,e("div",$e,_($.value),1)])]),e("div",Pe,[Fe,e("div",Te,[He,(m(!0),f(B,null,A(T.value,t=>(m(),f("label",null,[D(e("input",{type:"radio",value:t.name,class:"peer hidden",name:t.name,"onUpdate:modelValue":o[1]||(o[1]=a=>k.value=a)},null,8,Ue),[[K,k.value]]),e("div",qe,[e("h2",Ge,_(t.name),1),Re])]))),256))]),e("div",Ye,[e("span",null,_(F.value),1)])]),e("div",{class:"flex relative pb-12"},[Je,e("div",{class:"flex flex-row items-center gap-5 mr-96"},[e("button",{class:"btn btn-outline btn-info mr-40",onClick:ce},"预测")])]),e("div",Ke,[Qe,e("div",We,[e("button",{class:"btn btn-outline btn-success",onClick:ne},"准确率"),e("div",Xe,[e("div",{tabindex:"0",role:"button",class:"btn m-1",onClick:O},"显示错误样本"),e("ul",Ze,[(m(!0),f(B,null,A(R.value,t=>(m(),f("li",{onClick:a=>oe(t.name)},[e("a",null,_(t.name)+" - "+_(t.number),1)],8,et))),256))])])])])])])])]),D(e("div",tt,[e("div",st,[e("div",ot,[e("div",null,[e("span",nt," 预测耗时: "+_(I.value)+" 秒 ",1)]),e("div",at,[e("span",lt,_(x.value)+" % ",1)])]),e("div",ct,[e("div",{style:ve(`width: ${x.value}%`),class:"shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500"},null,4)])])],512),[[Q,E.value]]),D(e("div",null,[e("div",it,[e("div",rt,[dt,e("div",ut,_(H.value),1)]),e("div",_t,[pt,e("div",ht,_(U.value),1)]),e("div",mt,[ft,e("div",vt,_(q.value),1)])]),gt,wt,xt,bt],512),[[Q,M.value]]),e("section",yt,[e("div",kt,[e("div",jt,[(m(!0),f(B,null,A(N.value,t=>(m(),f("div",Ct,[e("div",Bt,[e("p",zt,_(t.content),1),e("p",Et,[e("span",Mt,[W("预测 "),e("span",At,_(t.predict),1)])]),e("p",Dt,[e("span",St,[W("人工 "),e("span",It,_(t.human),1)])])])]))),256))])])])])],64))}});export{Tt as default};
