import{d as Y,g as l,k as Z,h as ee,T as te,o as f,b as m,a,A as se,P as ae,F as $,e as I,t as P,p as H,n as oe,z as ne,E as _,K as le,q as ce,s as re,_ as ie}from"./index-f50d6d08.js";import{a as ue}from"./axios-a342f982.js";const U=w=>(ce("data-v-5b7ff6e1"),w=w(),re(),w),de={class:"min-h-screen bg-gray-900"},pe={class:"bg-gray-800 p-4 flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0"},ve={class:"flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-4 sm:space-y-0"},fe={class:"flex items-center justify-center sm:justify-start space-x-2"},me=U(()=>a("label",{for:"voice-select",class:"text-white text-sm"},"声音选择:",-1)),ye=["disabled"],ge=["value"],he={class:"container mx-auto p-4"},_e={class:"grid grid-cols-1 sm:grid-cols-2 gap-4"},be={class:"flex flex-col space-y-4"},we={class:"bg-gray-800 rounded-lg p-4"},xe=U(()=>a("h2",{class:"text-xl mb-4 text-white"},"Agent",-1)),ke={class:"mt-8"},De={class:"bg-gray-700 p-4 rounded-lg"},Se=U(()=>a("div",{class:"flex items-center space-x-2"},[a("span",{class:"bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm"},"MICROPHONE"),a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-blue-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"})])],-1)),Ae={key:0,class:"waveform-container mt-4"},Ce={class:"bg-gray-800 rounded-lg p-4"},Be={class:"h-[600px] overflow-y-auto"},Me=Y({__name:"basic",setup(w){const x="https://ai.minitool.fun:15401",O=x.replace("https://","wss://").replace("http://","ws://");l("property management service");const y=l(!1),g=l(!1),k=l(!1),E=l(!0),d=l([]);d.value.push({type:"system",content:"欢迎使用实时访谈系统,点击Connect开始。",timestamp:new Date});const S=l(null),A=l(null),p=l([]),C=l(Array(20).fill(5));let u=null,b=null,v=null,D=null;const B=l("amuch"),V=l(["amuch","dan"]),r=l(null);let h=null;const M=[];let N=!1;const z=async()=>{_({title:"开始收音",message:"收音中",type:"info"});try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});u=new(window.AudioContext||window.webkitAudioContext),b=u.createMediaStreamSource(e),v=u.createAnalyser(),v.fftSize=64,D=new Uint8Array(v.frequencyBinCount),h=u.createScriptProcessor(4096,1,1),b.connect(v),b.connect(h),h.connect(u.destination),h.onaudioprocess=F,g.value=!0,T()}catch(e){console.error("Error accessing microphone:",e),p.value.push({type:"system",content:"访问麦克风出错。请检查权限设置。",timestamp:new Date})}},j=e=>{const s=new ArrayBuffer(e.length*2),t=new DataView(s);for(let o=0;o<e.length;o++){const c=Math.max(-1,Math.min(1,e[o]));t.setInt16(o*2,c<0?c*32768:c*32767,!0)}return s},q=e=>{const s=j(e),t=new Uint8Array(s);let o="";const c=32768;for(let n=0;n<t.length;n+=c){const i=t.subarray(n,n+c);o+=String.fromCharCode.apply(null,Array.from(i))}return btoa(o)},F=e=>{const s=e.inputBuffer.getChannelData(0),t=q(s);J(t)},J=e=>{if(r.value&&r.value.readyState===WebSocket.OPEN){const s={event:"media",media:{payload:e}};r.value.send(JSON.stringify(s)),p.value.push({type:"sent",content:"发送了音频数据到后台",timestamp:new Date})}},R=()=>{b&&v&&(_({title:"停止收音",message:"收音结束",type:"info"}),b.disconnect(),v.disconnect(),h&&(h.disconnect(),h.onaudioprocess=null),g.value=!1)},L=()=>{var e;y.value?((e=r.value)==null||e.close(),y.value=!1,g.value=!1,R()):G()},G=()=>{d.value=[],p.value=[];const e="chikka";try{r.value=new WebSocket(`${O}/ws/voice-stream/${e}?voice=${B.value}`),r.value.onerror=()=>{_({title:"错误",message:"WebSocket连接失败，服务器可能未启动或网络有问题。",type:"error",duration:5e3})}}catch(s){_({title:"异常",message:`创建WebSocket时发生错误，后台服务器没启动：${s.message}`,type:"error",duration:5e3})}r.value.onopen=()=>{y.value=!0,p.value.push({type:"system",content:"连接后台成功",timestamp:new Date}),z()},r.value.onmessage=s=>{var o,c;const t=JSON.parse(s.data);if(t.event==="media")p.value.push({type:"received",content:"收到了后台语音数据",timestamp:new Date}),M.push(t.media.payload),N||W();else if(t.event==="message"){console.log(t);let n=t.response.type;if(t.response.type==="response.audio.delta"?n=n+": 音频子节长度"+t.response.delta.length:n=n+": "+t.response.delta,p.value.push({type:"system",content:n,timestamp:new Date}),((o=t.response)==null?void 0:o.type)==="response.audio_transcript.delta"){const i=t.response.delta;g.value&&(R(),g.value=!1,p.value.push({type:"system",content:"已停止录音，后台正在处理数据。",timestamp:new Date})),!k.value||d.value.length===0?(k.value=!0,d.value.push({type:"sent",content:"用户声音消息...",timestamp:new Date}),d.value.push({type:"received",content:i,timestamp:new Date})):d.value[d.value.length-1].content+=i}((c=t.response)==null?void 0:c.type)==="response.audio_transcript.done"&&(E.value=!0)}Q()},r.value.onclose=()=>{y.value=!1,p.value.push({type:"system",content:"Disconnected from server",timestamp:new Date})}},T=()=>{if(v&&D){v.getByteFrequencyData(D);for(let e=0;e<C.value.length;e++)C.value[e]=(D[e]||0)/2;g.value&&requestAnimationFrame(T)}},W=()=>{if(M.length>0){const e=M.shift();e&&(K(e,()=>{N=!1,W()}),N=!0)}else k.value=!1};Z([k,E],([e,s])=>{!e&&s&&z()});const K=(e,s)=>{const t=Uint8Array.from(atob(e),i=>i.charCodeAt(0)),o=u.createBuffer(1,t.length/2,44100),c=new Int16Array(t.buffer);for(let i=0;i<c.length;i++)o.getChannelData(0)[i]=c[i]/32768;const n=u.createBufferSource();n.buffer=o,n.connect(u.destination),n.playbackRate.value=.6,n.onended=s,n.start()},Q=async()=>{await le(),A.value&&(A.value.scrollTop=A.value.scrollHeight),S.value&&(S.value.scrollTop=S.value.scrollHeight)};async function X(){try{const e=await ue.get(`${x}/api/voice`);e.data.length>0?V.value=e.data:_({title:"服务器没有返回Pong",message:`请联系管理员检查服务器地址${x}`,type:"error"})}catch(e){_({title:"连接服务器失败",message:`请检查网络连接${x},${e}`,type:"error"})}}return ee(async()=>{await X()}),te(()=>{r.value&&r.value.close(),u&&u.close()}),(e,s)=>(f(),m("div",de,[a("header",pe,[a("div",ve,[a("div",fe,[me,se(a("select",{id:"voice-select","onUpdate:modelValue":s[0]||(s[0]=t=>B.value=t),disabled:y.value,class:"px-3 py-2 rounded-lg bg-gray-300 text-gray-800 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 hover:shadow-md"},[(f(!0),m($,null,I(V.value,t=>(f(),m("option",{key:t,value:t},P(t),9,ge))),128))],8,ye),[[ae,B.value]])]),a("button",{onClick:L,class:H(["px-4 py-2 rounded-lg font-medium",y.value?"bg-red-600 hover:bg-red-700":"bg-blue-600 hover:bg-blue-700","text-white"])},P(y.value?"Disconnect":"Connect"),3)])]),a("div",he,[a("div",_e,[a("div",be,[a("div",we,[xe,a("div",ke,[a("div",De,[Se,g.value?(f(),m("div",Ae,[(f(!0),m($,null,I(C.value,(t,o)=>(f(),m("div",{key:o,style:oe({height:`${t}px`}),class:"waveform-bar"},null,4))),128))])):ne("",!0)])])])]),a("div",Ce,[a("div",Be,[(f(!0),m($,null,I(d.value,(t,o)=>(f(),m("div",{key:o,class:H(["mb-4 p-2 rounded",{"bg-yellow-600":t.type==="system","bg-blue-600":t.type==="sent","bg-green-600":t.type==="received"}])},P(t.content),3))),128))])])])])]))}});const Ie=ie(Me,[["__scopeId","data-v-5b7ff6e1"]]);export{Ie as default};
