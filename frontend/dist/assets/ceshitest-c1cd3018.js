import{d as me,L as fe,g as u,y as he,k as J,h as ve,o as h,b as v,f as ge,a as e,F as C,e as A,A as S,M as K,t as _,B as Q,n as we,j as W,U as D,E as y}from"./index-f50d6d08.js";import{a as xe,_ as be}from"./navHeader.vue_vue_type_script_setup_true_lang-5f81fcc5.js";import{d as ye}from"./api-e233926e.js";import{i as X}from"./index-cbf34b5d.js";import{a as ke}from"./axios-a342f982.js";import{l as je}from"./lodash-0e7c12dd.js";const Ce=e("div",{class:"text-center text-3xl font-bold text-cyan-400"},"测试情感",-1),Be={class:"text-gray-600 body-font"},Me={class:"container px-3 pt-10 mx-auto flex flex-wrap"},ze={class:"flex flex-wrap w-full"},Ae={class:"w-full md:pr-10 md:py-6"},Se={class:"flex relative pb-12"},De=D('<div class="h-full w-10 absolute inset-0 flex items-center justify-center"><div class="h-full w-1 bg-gray-200 pointer-events-none"></div></div><div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-500 inline-flex items-center justify-center text-white relative z-10"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg></div><div class="flex-grow pl-4"><h2 class="font-medium title-font text-sm text-gray-900 mb-1 tracking-wider">STEP 1</h2><p class="leading-relaxed">选择数据，输入prompt name，获取对应的数据集</p></div>',3),Ee={class:"flex flex-row items-center"},Ne=e("p",{class:"ml-4"},"选择渠道：",-1),Ve=["value","name"],$e={class:"hover:bg-gray-50 flex items-center justify-between px-3 py-1 border-2 rounded-lg cursor-pointer text-sm border-gray-200 group peer-checked:border-blue-500"},Fe={class:"font-medium text-gray-700"},Ie=e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-9 h-9 text-blue-600 invisible group-[.peer:checked+&]:visible"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),Le={class:"text-center my-auto mx-2"},Pe=e("span",null,"数据量:",-1),Te={class:"badge badge-lg"},Oe={class:"flex relative pb-12"},He=D('<div class="h-full w-10 absolute inset-0 flex items-center justify-center"><div class="h-full w-1 bg-gray-200 pointer-events-none"></div></div><div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-500 inline-flex items-center justify-center text-white relative z-10"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg></div><div class="flex-grow pl-4"><h2 class="font-medium title-font text-sm text-gray-900 mb-1 tracking-wider">STEP 2</h2><p class="leading-relaxed">选择模型，使用哪个模型进行预测</p></div>',3),Ue={class:"flex flex-row items-center"},qe=e("p",{class:"ml-4"},"模型：",-1),Re=["value","name"],Ye={class:"hover:bg-gray-50 flex items-center justify-between px-3 py-1 border-2 rounded-lg cursor-pointer text-sm border-gray-200 group peer-checked:border-blue-500"},Ge={class:"font-medium text-gray-700"},Je=e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-9 h-9 text-blue-600 invisible group-[.peer:checked+&]:visible"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),Ke={class:"text-center my-auto mx-2"},Qe=D('<div class="h-full w-10 absolute inset-0 flex items-center justify-center"><div class="h-full w-1 bg-gray-200 pointer-events-none"></div></div><div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-500 inline-flex items-center justify-center text-white relative z-10"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div><div class="flex-grow pl-4"><h2 class="font-medium title-font text-sm text-gray-900 mb-1 tracking-wider">STEP 3</h2><p class="leading-relaxed">模型预测</p></div>',3),We={class:"flex relative"},Xe=D('<div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-500 inline-flex items-center justify-center text-white relative z-10"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path><path d="M22 4L12 14.01l-3-3"></path></svg></div><div class="flex-grow pl-4"><h2 class="font-medium title-font text-sm text-gray-900 mb-1 tracking-wider">FINISH</h2><p class="leading-relaxed">查看和分析结果.</p></div>',2),Ze={class:"flex flex-row items-center gap-5 mr-96"},et={class:"dropdown"},tt={tabindex:"0",class:"dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52"},st=["onClick"],nt={class:"w-11/12 mx-auto"},ot={class:"relative pt-1"},lt={class:"flex mb-2 items-center justify-between"},at={class:"text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200"},it={class:"text-right"},ct={class:"text-xs font-semibold inline-block text-blue-600"},rt={class:"overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200"},dt={class:"stats shadow mx-auto"},ut={class:"stat"},_t=e("div",{class:"stat-title"},"准确率",-1),pt={class:"stat-value"},mt={class:"stat"},ft=e("div",{class:"stat-title"},"正确预测结果数(一条评论有多个预测)",-1),ht={class:"stat-value"},vt={class:"stat"},gt=e("div",{class:"stat-title"},"错误数",-1),wt={class:"stat-value"},xt=e("div",{id:"accuracy-pie",class:"w-full h-96"},null,-1),bt=e("div",{id:"accuracy-category",class:"w-full h-96"},null,-1),yt={class:"text-gray-600 body-font"},kt={class:"container px-5 py-24 mx-auto"},jt={class:"flex flex-wrap -m-4"},Ct={class:"p-4 md:w-1/2 w-full"},Bt={class:"h-full bg-gray-100 p-8 rounded"},Mt={class:"leading-relaxed mb-6"},zt={class:"flex items-center"},At={class:"flex-grow flex flex-col pl-4"},St={class:"title-font font-medium text-gray-900 whitespace-pre-wrap"},Dt={class:"flex items-center mt-2"},Et={class:"flex-grow flex flex-col pl-4"},Nt={class:"text-gray-500 text-sm whitespace-pre-wrap"},Ot=me({__name:"ceshitest",setup(Vt){const{usecache:Z}=fe(xe()),ee=u(["weibo0","tiktoktest","shoptest","weibotest","redhattest","test"]),B=u("weibo0"),g=u([]),I=u(0),L=u([]),P=u("Factory模型经过训练过的模型，经过情感训练了3个epoch"),T=u([{name:"Factory",description:"Factory模型经过训练过的模型，经过情感训练了3个epoch"},{name:"DocChat",description:"DocChat模型基于文档的问答模型，没有经过情感训练"},{name:"Yi34B",description:"Yi34B模型，但是参数量大，没有经过情感训练"},{name:"mtdnn",description:"传统的编码器模型"}]),k=u("Factory"),te="https://ai.minitool.fun:6677",se="https://ai.minitool.fun:3326",M=u(!1),E=u(0),w=u(0),z=u(!1),O=u(0),H=u(0),U=u(0),q={正向:"积极",负向:"消极",中性:"中性"},N=["馅料","味道","包装","便捷程度","场景","服务","价格","口感","烹饪方法","皮","气味","外形","质量缺陷"],ne=N.concat(Object.values(q)),R=u(!1),V=u([]),Y=he(()=>{let s=[];for(let n of ne)s.push({name:n,number:0});return s});function $(){let s={},n=[];for(let t of g.value){const o=t.predict_answers,i=t.human_answers,d=t.id;console.log(o),console.log(i);for(let c of i){const r=c.subject,l=c.relation,a=c.guest,f=c.sentiment;for(let p of o){const j=p.subject,x=p.relation,m=p.guest,b=p.sentiment;if(j===r&&x===l&&m===a&&b!==f){if(s[b]||(s[b]=[]),n.includes(d))continue;n.push(d),s[b].push(t),s[l]||(s[l]=[]),s[l].push(t)}}}}for(let t in s){const o=s[t].length;Y.value.filter(i=>i.name===t)[0].number=o}return s}function oe(s){if(w.value!==100){y.warning({title:"警告",message:"请先进行预测，才能进行分析"});return}M.value=!1,z.value=!1;const n=$();if(n[s]){V.value=[],R.value=!0;for(let t of n[s]){const o=t.messages[0].content,i=t.predict_answers,d=t.messages[1].content;let c="";for(let l of i){const a=`${l.subject} ${l.relation} ${l.guest} ${l.sentiment}`;c+=a+`
`}const r={content:o,predict:c,human:d};V.value.push(r)}y.info({title:"成功",message:"请查看刷新后的样本"})}else y.warning({title:"警告",message:"您选择的类型没有错误样本"})}function le(){if(w.value!==100){y.warning({title:"警告",message:"请先进行预测，才能进行分析"});return}y.info({title:"警告",message:"点击按钮2次，绘图就可以正常显示"}),z.value=!0,M.value=!1,R.value=!1;let s=0,n=0,t={积极:[1,1],消极:[1,1],中性:[1,1]},o={};for(let c of N)o[c]=[1,1];for(let c of g.value){const r=c.predict_answers,l=c.human_answers;console.log(r),console.log(l);for(let a of l){const f=a.subject,p=a.relation,j=a.guest,x=a.sentiment;for(let m of r){const b=m.subject,_e=m.relation,pe=m.guest,F=m.sentiment;b===f&&_e===p&&pe===j&&(F===x?(n+=1,t[F][0]+=1,o[p][0]+=1):(s+=1,t[F][1]+=1,o[p][1]+=1))}}}H.value=n,U.value=s,O.value=n/(n+s)*100,ae(t);const i=Object.values(o).map(c=>c[0]),d=Object.values(o).map(c=>c[1]);ie(N,i,d)}const ae=s=>{document.getElementById("accuracy-pie").setAttribute("_echarts_instance_","");var n=document.getElementById("accuracy-pie"),t=X(n);const o={legend:{},tooltip:{},dataset:{source:[["product","积极","消极","中性"],["正确",s.积极[0],s.消极[0],s.中性[0]],["错误",s.积极[1],s.消极[1],s.中性[1]]]},series:[{type:"pie",radius:"20%",center:["10%","50%"],encode:{itemName:"product",value:"积极"},label:{show:!0,formatter:"{b}: ({d}%)"}},{type:"pie",radius:"20%",center:["50%","50%"],encode:{itemName:"product",value:"消极"},label:{show:!0,formatter:"{b}: ({d}%)"}},{type:"pie",radius:"20%",center:["90%","50%"],encode:{itemName:"product",value:"中性"},label:{show:!0,formatter:"{b}: ({d}%)"}}],title:[{text:"积极",left:"10%",top:"70%",textAlign:"center"},{text:"消极",left:"50%",top:"70%",textAlign:"center"},{text:"中性",left:"90%",top:"70%",textAlign:"center"}]};o&&t.setOption(o),window.onresize=()=>{t.resize()}},ie=(s,n,t)=>{document.getElementById("accuracy-category").setAttribute("_echarts_instance_","");var o=document.getElementById("accuracy-category"),i=X(o);const d={title:{text:"13个维度预测结果的统计"},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},legend:{},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"value",boundaryGap:[0,.01]},yAxis:{type:"category",data:s},series:[{name:"正确",type:"bar",data:n},{name:"错误",type:"bar",data:t}]};d&&i.setOption(d),window.onresize=()=>{i.resize()}};async function ce(){M.value=!0,E.value=0;const s=new Date().getTime();for(let n in g.value){console.log("正在预测第",n,"条数据");const t=g.value[n],o=t.messages,{human_answers:i,comments:d}=de(o),c=await ue(i,d);t.predict_answers=c,t.human_answers=i,g.value[n]=t,E.value=Math.round((new Date().getTime()-s)/1e3),w.value=Math.round(+n/g.value.length*100)}w.value=100,console.log("预测完成,预测结果是:",g.value),$()}async function re(s,n,t){let o=te;k.value==="mtdnn"&&(o=se);try{return(await ke.post(o+"/food_sentiment/predict",{content:s,keyword:n,model:k.value,usecache:Z.value,nocache:!1,...t})).data.data}catch(i){console.log(i),y({title:"Error",message:"处理请求情感接口失败"})}}function de(s){let n=[],t="";const o=s[0].content,i=s[1].content;if(o.includes("主体是")&&o.includes("关系和客体包括")){var d=o.split("-->");t=d[0]}if(i==="无")return{human_answers:n,comments:t};const c=i.split(`
`);for(let r of c){r=r.replace("，",","),r=r.replace("(","").replace(")","");const l=r.split(",").map(f=>f.trim());if(l.length!=4){console.warn("数据出现错误，该数据切分后应该有4个元素",r);continue}const a={subject:l[0],relation:l[1],guest:l[2],sentiment:l[3]};n.push(a)}return n.sort((r,l)=>r.subject.localeCompare(l.subject)),{human_answers:n,comments:t}}async function ue(s,n){let t=je.cloneDeep(s);const o=t.map(d=>d.subject),i=Array.from(new Set(o));for(let d of i){const c=t.filter(a=>a.subject===d);let r={};for(let a of c)a.relation in r?r[a.relation].push(a.guest):r[a.relation]=[a.guest];const l=await re(n,d,r);for(let a in l)for(let f of r[a]){const p=l[a][f].sentiment,j=q[p],x=t.findIndex(m=>m.subject===d&&m.relation===a&&m.guest===f);x!==-1?t[x].sentiment=j:console.warn("预测结果中，找不到对应的主体和关系，无法修改情感，这是不对的:",d,a,f)}}return console.log("情感识别的预测结果:",t),t}J(k,s=>{P.value=T.value.find(n=>n.name===s).description}),J(B,s=>{G(),z.value=!1,w.value=0});function G(){const s=B.value,n=L.value.filter(t=>t.prompt_name.includes(s));console.log(`根据channel为${s}获取到的数据数量为${n.length}`),g.value=n,I.value=n.length}return ve(async()=>{const s=await ye({mode:"detail",limit:-1});L.value=s.data,G()}),(s,n)=>(h(),v(C,null,[ge(be),e("div",null,[Ce,e("section",Be,[e("div",Me,[e("div",ze,[e("div",Ae,[e("div",Se,[De,e("div",Ee,[Ne,(h(!0),v(C,null,A(ee.value,t=>(h(),v("label",null,[S(e("input",{type:"radio",value:t,class:"peer hidden",name:t,"onUpdate:modelValue":n[0]||(n[0]=o=>B.value=o)},null,8,Ve),[[K,B.value]]),e("div",$e,[e("h2",Fe,_(t),1),Ie])]))),256))]),e("div",Le,[Pe,e("div",Te,_(I.value),1)])]),e("div",Oe,[He,e("div",Ue,[qe,(h(!0),v(C,null,A(T.value,t=>(h(),v("label",null,[S(e("input",{type:"radio",value:t.name,class:"peer hidden",name:t.name,"onUpdate:modelValue":n[1]||(n[1]=o=>k.value=o)},null,8,Re),[[K,k.value]]),e("div",Ye,[e("h2",Ge,_(t.name),1),Je])]))),256))]),e("div",Ke,[e("span",null,_(P.value),1)])]),e("div",{class:"flex relative pb-12"},[Qe,e("div",{class:"flex flex-row items-center gap-5 mr-96"},[e("button",{class:"btn btn-outline btn-info mr-40",onClick:ce},"预测")])]),e("div",We,[Xe,e("div",Ze,[e("button",{class:"btn btn-outline btn-success",onClick:le},"准确率"),e("div",et,[e("div",{tabindex:"0",role:"button",class:"btn m-1",onClick:$},"显示错误样本"),e("ul",tt,[(h(!0),v(C,null,A(Y.value,t=>(h(),v("li",{onClick:o=>oe(t.name)},[e("a",null,_(t.name)+" - "+_(t.number),1)],8,st))),256))])])])])])])])]),S(e("div",nt,[e("div",ot,[e("div",lt,[e("div",null,[e("span",at," 预测耗时: "+_(E.value)+" 秒 ",1)]),e("div",it,[e("span",ct,_(w.value)+" % ",1)])]),e("div",rt,[e("div",{style:we(`width: ${w.value}%`),class:"shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500"},null,4)])])],512),[[Q,M.value]]),S(e("div",null,[e("div",dt,[e("div",ut,[_t,e("div",pt,_(O.value),1)]),e("div",mt,[ft,e("div",ht,_(H.value),1)]),e("div",vt,[gt,e("div",wt,_(U.value),1)])]),xt,bt],512),[[Q,z.value]]),e("section",yt,[e("div",kt,[e("div",jt,[(h(!0),v(C,null,A(V.value,t=>(h(),v("div",Ct,[e("div",Bt,[e("p",Mt,_(t.content),1),e("p",zt,[e("span",At,[W("预测 "),e("span",St,_(t.predict),1)])]),e("p",Dt,[e("span",Et,[W("人工 "),e("span",Nt,_(t.human),1)])])])]))),256))])])])])],64))}});export{Ot as default};
