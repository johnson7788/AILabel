import{d as he,L as I,g as p,y as Y,h as me,r as x,$ as we,o as i,b as r,f as u,a as n,F as V,e as $,p as Q,A as B,C as Z,t as E,i as _,D as ye,G as be,w as v,j as g,c as ke,O as qe,z,B as ee,E as d}from"./index-f50d6d08.js";import{a as te}from"./axios-a342f982.js";import{u as K,a as xe,_ as Ce}from"./navHeader.vue_vue_type_script_setup_true_lang-f1ba1dcd.js";import{_ as Se,a as Ae}from"./IconPerson-61fc7cba.js";import{_ as Oe}from"./utils-b0e14b16.js";import{g as Pe,a as Ve,b as Me,q as $e,s as le}from"./api-a3faf747.js";import"./index-cbf34b5d.js";const Qe={class:"w-screen flex mx-auto my-0 p-2"},Be={class:"left h-screen w-1/2 rounded"},Ee={class:"w-full h-full overflow-auto border-r-2 border-gray-300 rounded-sm"},Le=["msgId","onDblclick","innerHTML"],Ne=["onUpdate:modelValue"],De={key:0,class:"w-6 h-6 mt-1"},Te={key:1,class:"w-6 h-6 mt-1"},Ue={class:"text-ellipsis overflow-hidden w-full text-center leading-4"},je={class:"text-sm leading-4"},Ie={class:"flex w-full h-12 grow"},ze={class:"right bg-white w-1/2"},Ke=n("div",{class:"text-center mb-2"},"三种标注模式 ",-1),Fe={class:"flex justify-between items-center flex-wrap w-4/5"},Ge=n("span",null,"prompt:",-1),Re=["disabled"],We={key:0,class:"loading loading-spinner"},He={key:0},Je={key:1},Xe={class:"card-body p-6"},Ye={class:"card-title"},Ze=["onClick"],et=["onClick"],vt=he({__name:"labelAgent",setup(tt){const{currentQuestion:o,messages:e,function_results:lt,message_tool_names:F,tools_data:L,multi_llm_results:N}=I(K()),{selectedLLM:st,sample_idx:y,selectedSample:G,usecache:ot,currentPrompt:C}=I(xe());K();const{display_neo4j_meta:R,display_plot_meta:W,need_summary:H}=I(K()),M=p(-1);Y(()=>o.value.question_type==="observation"||o.value.question_type==="function_call");const D=p(null),T=p(),se=p();p([]);const S=p(),U=p(!1),A=p(!1),b=p(!1),J="https://ai.minitool.fun:15557",j=p("请输入或双击对话修改,Shift+enter提交"),h=p("");function oe(){o.value.question_type="user",j.value="User: 请输入问题",D.value.focus()}function ae(){o.value.question_type="SOP",j.value="User: 请输入问题,输入完问题，旁边框输入SOP",D.value.focus()}function ne(){e.value=[],o.value.question="",o.value.question_id=-1,o.value.question_type="",b.value&&(y.value+=1),b.value=!1,R.value="",W.value="",H.value=!0}async function ue(){A.value=!0;const l=await te.post(`${J}/api/generate_qa`,{workflow:!0,fake:!0});console.log(l);const s=l.data,a=s.msg;if(s.code==0){const c=s.data,O=c.question,m=c.answer,k=c.workflow_output,q=c.intermidiates;e.value.push({id:1,role:"user",content:O}),e.value.push({id:e.value[e.value.length-1].id+1,role:"SOP",content:k}),q.forEach(w=>{w.status==="AgentAction"?(e.value.push({id:e.value[e.value.length-1].id+1,role:"thought",content:w.thought}),e.value.push({id:e.value[e.value.length-1].id+1,role:"observation",content:w.observation})):e.value.push({id:e.value[e.value.length-1].id+1,role:"thought",content:w.thought})}),e.value.push({id:e.value[e.value.length-1].id+1,role:"assistant",content:m,meta:c})}else d({title:"错误",message:"生成问答对失败:"+a,type:"warning"});A.value=!1}const ie=Y(()=>e.value.length===0||e.value[e.value.length-1].role==="gpt");function re(l){e.value.push({id:e.value[e.value.length-1].id+1,role:"gpt",content:l}),U.value=!1,N.value=[]}function ce(l){const s=JSON.stringify(l);e.value.push({id:e.value[e.value.length-1].id+1,role:"function_call",content:s}),U.value=!1,N.value=[]}async function de(){if(S.value||d.info("你还没有在管理界面设置Sample问题类型，请先进行设置后，在使用sample按钮"),b.value=!0,y.value<=S.value.length){const l=S.value[y.value];if(e.value.length===0){const s=await $e({questions:[l]});console.log("query_result:",s),s.code===0&&(s.data[0].status!=="unlabeled"?e.value=s.data[0].messages:e.value.push({id:1,role:"user",content:l}))}else e.value[e.value.length-1].role==="gpt"?e.value.push({id:e.value[e.value.length-1].id+1,role:"user",content:l}):d.warning("上一条消息不是assistant，或者不是第一条信息，无法添加user的问题")}else d.warning("没有更多的的样本了,请在管理中设置样本数据集和样本的起始序号")}async function ve(){const l=await le({messages:e.value,prompt:C.value,tools:F.value,collection:"wronglabel"});console.log("数据的保存结果:",l),l.code===0?d({message:"保存错误回答数据成功到后台，请对当前数据继续进行修改",type:"info"}):d({message:"保存数据失败，请检查后端日志",type:"error"})}async function pe(){const l=await le({messages:e.value,prompt:C.value,tools:F.value});console.log("数据的保存结果:",l),l.code===0?(d({message:"保存数据成功到后台",type:"info"}),e.value=[],o.value.question="",o.value.question_id=-1,o.value.question_type="",b.value&&(y.value+=1),b.value=!1,R.value="",W.value="",H.value=!0):d({message:"保存数据失败，请检查后端日志",type:"error"})}async function fe(){const l=e.value[e.value.length-1].role;if(l!=="user"&&l!=="SOP"){d({message:"最后一条消息不是用户或者SOP，无法进行回答",type:"warning"});return}A.value=!0;let s=!0;l==="SOP"&&(s=!1);const a=await te.post(`${J}/api/answer_messages`,{messages:e.value,workflow:s});console.log("Chat response:",a);const c=a.data,O=c.msg;if(c.code==0){const m=c.data,k=m.output,q=m.workflow_output,w=m.intermidiates;q&&e.value.push({id:e.value[e.value.length-1].id+1,role:"SOP",content:q}),w.forEach(t=>{t.status==="AgentAction"?(e.value.push({id:e.value[e.value.length-1].id+1,role:"thought",content:t.thought}),e.value.push({id:e.value[e.value.length-1].id+1,role:"observation",content:t.observation})):e.value.push({id:e.value[e.value.length-1].id+1,role:"thought",content:t.thought})}),e.value.push({id:e.value[e.value.length-1].id+1,role:"assistant",content:k,meta:m})}else d({title:"错误",message:"生成问答对失败:"+O,type:"warning"});A.value=!1}function _e(l){if(l!==-1){console.log("要删除message:",l);let s=e.value.filter(a=>a.id!==l);e.value=s,b.value&&e.value.length===0&&(y.value+=1),b.value=!1}else d({message:"没有选中任何信息，请双击1条信息，然后按delete键删除",type:"info"})}function ge(l){e.value.forEach((s,a)=>{a===l&&(o.value.question_type=s.role,M.value=l)})}function X(){if(o.value.question_id===-1&&e.value.length===0)e.value.push({id:1,role:"user",content:o.value.question}),h.value&&(e.value.push({id:e.value[e.value.length-1].id+1,role:"SOP",content:h.value}),h.value="");else{if(!o.value.question_type){d({message:"还没有选择当前消息的类型，请右边点击按钮选择类型",type:"info"});return}if(!o.value.question){h.value?(e.value.push({id:e.value[e.value.length-1].id+1,role:"SOP",content:h.value}),h.value=""):d({message:"你好像还么有输入任何內",type:"info"});return}const l=e.value[e.value.length-1].role;o.value.question_type===l&&d({message:"注意:连续2条都是同1个角色的消息",type:"warning"}),e.value.push({id:e.value[e.value.length-1].id+1,role:o.value.question_type,content:o.value.question})}o.value.question="",o.value.question_id=-1,o.value.question_type=""}return me(async()=>{const l=await Pe();T.value=l.data,console.log("prompts:",T.value);const s=await Ve();L.value=s.data,console.log("tools_data:",L.value),se.value=Object.keys(L.value);const a=await Me({keyword:G.value});console.log(a),a.data.forEach(c=>{c.prompt===G.value&&(S.value=c.questions)}),console.log(S.value),y.value=+y.value}),(l,s)=>{const a=x("el-button"),c=x("el-input"),O=x("el-option"),m=x("el-select"),k=x("el-row"),q=x("el-divider"),w=we("autogrow");return i(),r(V,null,[u(Ce),n("main",Qe,[n("div",Be,[n("div",Ee,[(i(!0),r(V,null,$(_(e),(t,f)=>(i(),r("div",{class:"leading-6 flex justify-between content-center relative grow",key:t.id},[n("div",{class:Q(["w-full flex justify-between my-1 py-1 rounded-sm",t.role==="user"?"flex-row bg-green-200":"flex-row-reverse bg-blue-200"])},[n("div",{class:Q(["font-medium flex-grow",{"bg-red-200":M.value===f}])},[M.value!==f?(i(),r("div",{key:0,class:Q(["mx-2 whitespace-pre-wrap",t.role==="user"?"":"mr-8"]),msgId:t.id,onDblclick:P=>ge(f),innerHTML:t.display_content?t.display_content:t.content},null,42,Le)):B((i(),r("textarea",{key:1,"onUpdate:modelValue":P=>t.content=P,onBlur:s[0]||(s[0]=P=>M.value=-1),class:"w-full"},null,40,Ne)),[[Z,t.content],[w]])],2),n("div",{class:Q(["relative w-24 shrink-0 flex items-center box-border",t.role==="user"?"flex-row-reverse mr-8":"flex-row"])},[t.role==="user"?(i(),r("div",De,[u(Se)])):(i(),r("div",Te,[u(Ae)])),n("div",Ue,[n("span",je,E(t.role),1)])],2)],2),u(a,{size:"small",class:"hover:scale-110 absolute right-0 top-3",onClick:P=>_e(t.id),type:"danger",icon:"Delete",circle:""},null,8,["onClick"])]))),128))]),n("div",Ie,[u(c,{modelValue:_(o).question,"onUpdate:modelValue":s[1]||(s[1]=t=>_(o).question=t),autosize:"",type:"textarea",ref_key:"InputBox",ref:D,placeholder:j.value,onKeyup:ye(be(X,["shift"]),["enter"])},null,8,["modelValue","placeholder","onKeyup"]),u(a,{type:"success",onClick:X,title:"shift+enter提交"},{default:v(()=>[g("新增")]),_:1})])]),n("div",ze,[Ke,n("div",Fe,[n("div",null,[Ge,u(m,{modelValue:_(C),"onUpdate:modelValue":s[2]||(s[2]=t=>qe(C)?C.value=t:null),placeholder:"Select",style:{width:"100px"}},{default:v(()=>[(i(!0),r(V,null,$(T.value,(t,f)=>(i(),ke(O,{key:t.name,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),u(k,{class:"w-full"},{default:v(()=>[u(a,{type:_(o).question_type==="auto"?"primary":"success",round:"",onClick:ue},{default:v(()=>[g("Auto")]),_:1},8,["type"]),u(a,{type:_(o).question_type==="user"?"primary":"success",round:"",onClick:oe},{default:v(()=>[g("Question")]),_:1},8,["type"]),u(a,{type:_(o).question_type==="SOP"?"primary":"success",round:"",onClick:ae},{default:v(()=>[g("Question+SOP")]),_:1},8,["type"])]),_:1}),u(k,null,{default:v(()=>[u(a,{type:"danger",round:"",onClick:de},{default:v(()=>[g("Sample")]),_:1}),u(a,{type:"warning",round:"",onClick:ne},{default:v(()=>[g("Clear")]),_:1}),u(a,{type:"danger",round:"",onClick:pe},{default:v(()=>[g("Save&Correct")]),_:1}),u(a,{type:"danger",round:"",onClick:ve},{default:v(()=>[g("Wrong")]),_:1})]),_:1}),u(k,{class:"w-full"},{default:v(()=>[n("button",{class:"btn",onClick:fe,disabled:ie.value},[A.value?(i(),r("span",We)):z("",!0),g(" answer ")],8,Re)]),_:1})]),_(o).question_type==="SOP"?(i(),r("div",He,[u(q),B(n("textarea",{placeholder:"输入标准工作流计划和关键点，格式是,Workflow:  Key points:",class:"textarea textarea-bordered textarea-lg w-full","onUpdate:modelValue":s[3]||(s[3]=t=>h.value=t)},null,512),[[Z,h.value]])])):z("",!0),U.value?(i(),r("div",Je,[u(q),n("div",null,[(i(!0),r(V,null,$(_(N),t=>(i(),r("div",{class:"card w-full bg-base-300 shadow-xl mb-5",key:t.llm},[n("div",Xe,[n("h3",Ye,E(t.llm),1),B(n("button",{class:"btn btn-outline btn-success h-full",onClick:f=>re(t.response.content)},E(t.response.content),9,Ze),[[ee,t.response.tool_calls.length===0]]),B(n("div",null,[(i(!0),r(V,null,$(t.response.tool_calls,f=>(i(),r("button",{class:"btn btn-outline btn-success h-full",onClick:P=>ce(f)},E(f),9,et))),256))],512),[[ee,t.response.tool_calls.length!==0]])])]))),128))])])):z("",!0),u(Oe)])])],64)}}});export{vt as default};
