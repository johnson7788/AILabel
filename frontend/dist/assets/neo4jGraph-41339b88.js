import{L as X,g as Y,y as H,k as v,A as G,B as R,o as U,b as V,a as g,J as q,D as J,G as W}from"./index-f50d6d08.js";import{l as N}from"./lodash-0e7c12dd.js";import{u as F}from"./navHeader.vue_vue_type_script_setup_true_lang-f1ba1dcd.js";import{d as I}from"./api-a3faf747.js";import{b as Q}from"./brush-ad246980.js";import{s as c}from"./transform-4a56bf00.js";import{z as Z}from"./zoom-558520b2.js";import{s as ee,m as te}from"./manyBody-52170d67.js";import{l as C,x as oe,y as re,d as le}from"./y-d5417789.js";import{c as se}from"./create-8bd90eea.js";const ne={class:"w-full h-full border border-gray-100 overflow-auto bg-slate-500"},ae={class:"display_header flex justify-between items-center"},ie=g("div",{class:"properties w-full h-10 text-white"},null,-1),ce={class:"form-control"},de={class:"cursor-pointer label"},fe=["onKeydown"],Be={__name:"neo4jGraph",setup(pe){const{display_neo4j_meta:$,select_nodes:x}=X(F()),h=Y(!1),S=H(()=>!!$.value);v(x,(l,s)=>{console.log("select_nodes发生变化",l)},{deep:!0});const E=()=>{h.value=!h.value,console.log("框选状态已切换！")};v($,(l,s)=>{if(l){console.log("开始绘图",l);const{nodes:n,links:d}=b(l);B(n,d)}});function b(l){let s=[],n=[],d=[];return l.forEach(m=>{m.nodes.forEach(f=>{s.includes(f.id)||(n.push(f),s.push(f.id))}),d.push(m.links)}),console.log(new Date,"节点信息",n),console.log(new Date,"link信息",d),{nodes:n,links:d}}function B(l,s){let n=N.cloneDeep(l),d=N.cloneDeep(s);function m(e){var a;return((a=n.find(i=>i.id===e))==null?void 0:a.color)||"yellow"}console.log(new Date,`数据获取完成，共获取了${l.length}条节点数据，开始渲染`),console.log(new Date,"nodesCopy",n),console.log(new Date,"linksCopy",d);let f=c(".properties");const w=928,_=680;function z(e){return`
      M${e.source.x},${e.source.y}
      A0,0 0 0,1 ${e.target.x},${e.target.y}
    `}const L=e=>{function o(r,t){r.active||e.alphaTarget(.3).restart(),t.fx=t.x,t.fy=t.y}function a(r,t){t.fx=r.x,t.fy=r.y}function i(r,t){r.active||e.alphaTarget(0),t.fx=null,t.fy=null}return le().on("start",o).on("drag",a).on("end",i)},D=ee(l).force("link",C(s).id(e=>e.id)).force("charge",te().strength(-2e3)).force("x",oe(w/2)).force("y",re(_/2)).force("link",C(s).id(e=>e.id).distance(200)),p=se("svg").attr("viewBox",[-w/2,-_/2,w*2,_*2]).style("font","10px sans-serif"),K=Z().scaleExtent([-5,5]).on("zoom",function(e){p.selectAll("g").attr("transform",e.transform),p.selectAll("g").selectAll("g").attr("transform",e.transform)}),y=p.append("g"),A=y.append("defs").append("filter").attr("id","glow");A.append("feGaussianBlur").attr("stdDeviation","5").attr("result","coloredBlur");const M=A.append("feMerge");M.append("feMergeNode").attr("in","coloredBlur"),M.append("feMergeNode").attr("in","SourceGraphic");const O=y.selectAll("path").data(s).join("path").attr("fill","none").attr("stroke-width",2.5).attr("stroke","pink").attr("marker-end",e=>`url(${new URL(`#arrow-${e.type}`,location)})`).attr("id",(e,o)=>`linkPath${o}`).on("mouseover",function(e,o){c(this).style("filter","url(#glow)"),f.html(`类型: ${o.relation_type}`).style("left",e.pageX+10+"px").style("top",e.pageY-10+"px").style("opacity",1)}).on("mouseout",function(){c(this).style("filter","none"),f.style("opacity",0)});y.selectAll(".link-text").data(s).join("text").attr("class","link-text").append("textPath").attr("startOffset","50%").attr("fill","white").attr("xlink:href",(e,o)=>`#linkPath${o}`).text(e=>e.relation),y.selectAll("marker").data(s).join("marker").attr("id",e=>`arrow-${e.type}`).attr("viewBox","0 -5 10 10").attr("refX",25).attr("refY",-.5).attr("markerWidth",10).attr("markerHeight",10).attr("orient","auto").append("path").attr("fill","#add8e6").attr("d","M0,-5L10,0L0,5");const u=y.selectAll("a").data(l).join("a").on("mouseover",function(e,o){c(this).style("filter","url(#glow)"),f.html(`名称: ${o.name}, 类型: ${o.node_type}`).style("left",e.pageX+10+"px").style("top",e.pageY-10+"px").style("opacity",1)}).on("mouseout",function(){c(this).style("filter","none"),f.style("opacity",0)}).on("mousedown",function(){c(this).select("circle").style("stroke","red")}).on("mouseup",function(){c(this).select("circle").style("stroke","white")}).on("click",async function(e,o){const a=await I({property_name:"id",property_value:o.id});if(console.log("查询结果",a),a.code===0&&a.data.length>0){const{nodes:i,links:r}=b(a.data);console.log("current_nodes",i);const t=[...n];if(i.forEach(k=>{t.find(T=>T.id===k.id)||t.push(k)}),t.length>n.length){console.log("有新的节点加入，需要重新渲染");const k=r.concat(d);B(t,k)}}c(this).select("circle").style("stroke","white")});u.append("circle").attr("stroke","white").attr("stroke-width",1.5).data(l).attr("r",40).attr("fill",e=>e.color),u.append("text").text(e=>e.id).attr("text-anchor","middle").attr("dominant-baseline","middle").attr("fill","#483D8B").attr("stroke","#483D8B").attr("stroke-width",1),D.on("tick",()=>{O.attr("d",z),u.attr("transform",e=>`translate(${e.x},${e.y})`)});const P=()=>{let e="darkorange";function o(i){let r=i.selection;u.select("circle").style("fill",function(t){return r!==null&&r[0][0]<=t.x&&t.x<r[1][0]&&r[0][1]<=t.y&&t.y<r[1][1]?(x.value.includes(t.id)===!1&&x.value.push(t.id),e):m(t.id)})}function a(i){i.selection===null&&u.select("circle").style("fill",r=>m(r.id))}return Q().on("start brush",o).on("end",a)};function j(e){e?(u.on(".drag",null),p.on(".zoom",null),p.append("g").attr("class","brush").call(P())):(p.select(".brush").remove(),u.call(L(D)),p.call(K))}j(h.value),v(h,e=>{j(e)}),c(".knowledgeGraph").select("svg").remove(),c(".knowledgeGraph").append(()=>p.node())}return(l,s)=>G((U(),V("div",ne,[g("div",ae,[ie,g("div",ce,[g("label",de,[G(g("input",{type:"checkbox",class:"checkbox checkbox-info","onUpdate:modelValue":s[0]||(s[0]=n=>h.value=n),title:"开启选择模式,ctrl+a快速开启"},null,512),[[q,h.value]])])])]),g("div",{class:"knowledgeGraph",tabindex:"0",onKeydown:J(W(E,["ctrl"]),["a"])},null,40,fe)],512)),[[R,S.value]])}};export{Be as _};
