import{d as ce,L as Y,g as w,h as de,r as y,o as s,b as i,F as C,e as V,z as U,j as b,t as q,i as p,f as n,w as v,a as u,E as h,y as ie,$ as Ae,p as W,A as B,C as Ve,D as Se,G as Oe,c as Ne,O as Te,B as X,J as Re}from"./index-f50d6d08.js";import{u as Z,a as Le,_ as je}from"./navHeader.vue_vue_type_script_setup_true_lang-f1ba1dcd.js";import{_ as De,a as Be}from"./IconPerson-61fc7cba.js";import{_ as Ue}from"./neo4jGraph-41339b88.js";import{R as ve,_ as Ee}from"./utils-b0e14b16.js";import{g as Je,a as Qe,b as Fe,q as ze,s as Ge,c as re}from"./api-a3faf747.js";import"./lodash-0e7c12dd.js";import"./brush-ad246980.js";import"./transform-4a56bf00.js";import"./value-0eb832c3.js";import"./pointer-b52b12f8.js";import"./nodrag-71d5223e.js";import"./zoom-558520b2.js";import"./manyBody-52170d67.js";import"./y-d5417789.js";import"./create-8bd90eea.js";import"./index-cbf34b5d.js";import"./axios-a342f982.js";const He={class:"function"},Ie=["onClick"],Pe={key:0,class:"loading loading-spinner"},Ke={key:0},We=ce({__name:"functionDrawer",setup(pe){const{currentQuestion:a,tools_data:e}=Y(Z()),g=w(new Map),j=w(!1),S=w("");function O(){for(var c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",f="call_",d=0;d<24;d++)f+=c.charAt(Math.floor(Math.random()*c.length));return f}async function E(c){const f=e.value[c].params;console.log("提交参数:",f);let d=!0;if(f.forEach(M=>{M.required&&!M.value&&(h({message:`参数${M.name}为必填项，请检查`,type:"warning"}),d=!1)}),d){let M=f.reduce((A,m)=>(A[m.name]=m.value,A),{});const J=O(),Q=JSON.stringify([{name:c,id:J,arguments:M}]);a.value.question=Q,h({message:"参数提交成功",type:"info"}),j.value=!1,S.value=c,await ve(),S.value=""}}function $(c){Object.keys(e.value).map(f=>{g.value.set(f,!1)}),g.value.set(c,!g.value.get(c)),console.log("显示drawer:",c,g.value),j.value=!0}return de(async()=>{console.log("tools_data",e.value),e.value&&Object.keys(e.value).map(c=>{g.value.set(c,!1);const f=e.value[c].params;for(let d=0;d<f.length;d++)e.value[c].params[d].value=""})}),(c,f)=>{const d=y("el-input"),M=y("el-form-item"),J=y("el-form"),H=y("el-button"),Q=y("el-drawer");return s(),i("div",He,[(s(!0),i(C,null,V(p(e),(A,m)=>(s(),i("button",{class:"btn btn-outline btn-success",key:m,onClick:_=>$(m),text:"",bg:""},[S.value===m?(s(),i("span",Pe)):U("",!0),b(" "+q(m),1)],8,Ie))),128)),(s(!0),i(C,null,V(p(e),(A,m)=>(s(),i("div",{key:m},[g.value.get(m)?(s(),i("div",Ke,[n(Q,{modelValue:j.value,"onUpdate:modelValue":f[0]||(f[0]=_=>j.value=_),title:A.description,"with-header":!0},{default:v(()=>[(s(!0),i(C,null,V(A.params,_=>(s(),i("div",{class:"params",key:_.name},[n(J,{"label-width":"120px"},{default:v(()=>[n(M,{label:_.name},{default:v(()=>[u("div",null,q(_.type)+": "+q(_.description),1),n(d,{modelValue:_.value,"onUpdate:modelValue":N=>_.value=N,placeholder:_.required?"必填":"可选"},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label"])]),_:2},1024)]))),128)),n(H,{type:"success",onClick:_=>E(m)},{default:v(()=>[b("确认")]),_:2},1032,["onClick"])]),_:2},1032,["modelValue","title"])])):U("",!0)]))),128))])}}}),Xe={class:"w-screen flex mx-auto my-0 p-2"},Ye={class:"left h-screen w-1/2 rounded"},Ze={class:"w-full h-full overflow-auto border-r-2 border-gray-300 rounded-sm"},et=["msgId","onDblclick","innerHTML"],tt=["onUpdate:modelValue"],lt={key:0,class:"w-6 h-6 mt-1"},ot={key:1,class:"w-6 h-6 mt-1"},nt={class:"text-ellipsis overflow-hidden w-full text-center leading-4"},st={class:"text-sm leading-4"},at={class:"flex w-full h-12 grow"},ut={class:"right bg-white w-1/2"},it=u("div",{class:"text-center mb-2"},"点击任何按钮生成对应的对话 ",-1),rt={class:"flex justify-between items-center flex-wrap w-4/5"},ct=u("span",null,"prompt:",-1),dt=["disabled"],vt={key:0,class:"loading loading-spinner"},pt=["for"],ft=["id","value"],_t=u("div",{class:"pointer-events-none absolute top-2/4 left-2/4 -translate-y-2/4 -translate-x-2/4 text-white opacity-0 transition-opacity peer-checked:opacity-100"},[u("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",stroke:"currentColor","stroke-width":"1"},[u("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"})])],-1),mt=["for"],gt={key:0},ht={key:1},yt={class:"card w-96 bg-base-300 shadow-xl"},bt={key:2},wt={class:"card-body p-6"},kt={class:"card-title"},xt=["onClick"],Ct=["onClick"],Ft=ce({__name:"label",setup(pe){const{currentQuestion:a,messages:e,function_results:g,message_tool_names:j,tools_data:S,multi_llm_results:O}=Y(Z()),{selectedLLM:E,sample_idx:$,selectedSample:c,usecache:f,currentPrompt:d}=Y(Le()),{AddHumanMsg:M,AddGptMsg:J,AddFunctionMsg:H,AddObservationMsg:Q}=Z(),{display_neo4j_meta:A,display_plot_meta:m,need_summary:_}=Y(Z()),N=w(-1),fe=ie(()=>a.value.question_type==="observation"||a.value.question_type==="function_call"),ee=w(),F=w(!1),te=w(),D=w([]),z=w(),I=w(!1),G=w(!1),T=w(!1);function _e(l){return l instanceof Array?"array":l instanceof Date?"date":l instanceof RegExp?"regexp":typeof l}function me(){e.value=[],a.value.question="",a.value.question_id=-1,a.value.question_type="",T.value&&($.value+=1),T.value=!1,A.value="",m.value="",_.value=!0}async function ge(){ue(),D.value.length>0?(await P(),await se(),ae(),await P()):await P()}async function se(){Q(),e.value[e.value.length-1].role==="function_call"&&await ve()}const he=ie(()=>e.value.length===0||e.value[e.value.length-1].role==="gpt");function ae(){if(g.value.length===0){h({title:"提示",message:"函数没有执行完成或者还没执行函数",type:"warning"});return}a.value.question_type==="function_call"&&le();for(let l of g.value){let o=l.msg;const r=_e(o);(r==="array"||r==="object")&&(o=JSON.stringify(o,null,2)),e.value.push({id:e.value[e.value.length-1].id+1,role:"observation",content:o,tool_call_id:l.id,name:l.name,display_content:`${l.name}
${l.id}
${o}`})}_.value||e.value.push({id:e.value[e.value.length-1].id+1,role:"gpt",content:g.value}),g.value=[],_.value=!0}function ye(l){e.value.push({id:e.value[e.value.length-1].id+1,role:"gpt",content:l}),I.value=!1,O.value=[]}function be(l){const o=JSON.stringify(l);e.value.push({id:e.value[e.value.length-1].id+1,role:"function_call",content:o}),I.value=!1,O.value=[]}function we(){te.value.includes(c.value)&&(D.value.push(c.value),F.value=!0)}async function ue(){if(z.value||h.info("你还没有在管理界面设置Sample问题类型，请先进行设置后，在使用sample按钮"),T.value=!0,$.value<=z.value.length){const l=z.value[$.value];if(we(),e.value.length===0){const o=await ze({questions:[l]});console.log("query_result:",o),o.code===0&&(o.data[0].status!=="unlabeled"?e.value=o.data[0].messages:e.value.push({id:1,role:"human",content:l}))}else e.value[e.value.length-1].role==="gpt"?e.value.push({id:e.value[e.value.length-1].id+1,role:"human",content:l}):h.warning("上一条消息不是gpt，或者不是第一条信息，无法添加human的问题")}else h.warning("没有更多的的样本了,请在管理中设置样本数据集和样本的起始序号")}async function ke(){const l=await Ge({messages:e.value,prompt:d.value,tools:j.value});console.log("数据的保存结果:",l),l.code===0?(h({message:"保存数据成功到后台",type:"info"}),e.value=[],a.value.question="",a.value.question_id=-1,a.value.question_type="",T.value&&($.value+=1),T.value=!1,A.value="",m.value="",_.value=!0):h({message:"保存数据失败，请检查后端日志",type:"error"})}async function P(){const l=e.value[e.value.length-1].role;if(l!=="human"&&l!=="observation"){h({message:"最后一条消息不是用户或者observation，无法进行回答",type:"warning"});return}G.value=!0;const o=D.value.length===0?"empty":D.value.join(",");if(E.value.length===1){const r=await re({prompt:d.value,messages:e.value,llm:E.value,tools:o,usecache:f.value});console.log("Chat response:",r);const k=r.data[0].response.content;let R=r.data[0].response.tool_calls;if(N.value=-1,R.length>0){const K=JSON.stringify(R);e.value.push({id:e.value[e.value.length-1].id+1,role:"function_call",content:K,display_content:JSON.stringify(JSON.parse(K),null,2)})}else e.value.push({id:e.value[e.value.length-1].id+1,role:"gpt",content:k});G.value=!1}else{console.log("使用多个模型的回答"),O.value=[],I.value=!0;let r=E.value.map(k=>re({prompt:d.value,messages:e.value,llm:[k],tools:o,usecache:f.value}).then(R=>{console.log("llm:",k,"response:",R),O.value.push(R.data[0])}));Promise.all(r).then(()=>{console.log("All tasks have been done."),G.value=!1}).catch(k=>{console.log("An error has occurred: ",k),G.value=!1})}F.value=!1}function xe(l){if(l!==-1){console.log("要删除message:",l);let o=e.value.filter(r=>r.id!==l);e.value=o,T.value&&e.value.length===0&&($.value+=1),T.value=!1}else h({message:"没有选中任何信息，请双击1条信息，然后按delete键删除",type:"info"})}function Ce(l){e.value.forEach((o,r)=>{r===l&&(a.value.question_type=o.role,N.value=l)})}function le(){if(a.value.question_id===-1&&e.value.length===0)e.value.push({id:1,role:"human",content:a.value.question});else{if(!a.value.question_type){h({message:"还没有选择当前消息的类型，请右边点击按钮选择类型",type:"info"});return}if(!a.value.question){h({message:"你好像还么有输入任何內",type:"info"});return}const l=e.value[e.value.length-1].role;if(a.value.question_type===l){h({message:"不能连续2条都是同1个角色的消息",type:"info"});return}e.value.push({id:e.value[e.value.length-1].id+1,role:a.value.question_type,content:a.value.question})}a.value.question="",a.value.question_id=-1,a.value.question_type=""}return de(async()=>{const l=await Je();ee.value=l.data,console.log("prompts:",ee.value);const o=await Qe();S.value=o.data,console.log("tools_data:",S.value),te.value=Object.keys(S.value);const r=await Fe({keyword:c.value});console.log(r),r.data.forEach(k=>{k.prompt===c.value&&(z.value=k.questions)}),console.log(z.value),$.value=+$.value}),(l,o)=>{const r=y("el-button"),k=y("el-input"),R=y("el-option"),K=y("el-select"),oe=y("el-row"),qe=y("ArrowRight"),$e=y("el-icon"),ne=y("el-divider"),Me=Ae("autogrow");return s(),i(C,null,[n(je),u("main",Xe,[u("div",Ye,[u("div",Ze,[(s(!0),i(C,null,V(p(e),(t,x)=>(s(),i("div",{class:"leading-6 flex justify-between content-center relative grow",key:t.id},[u("div",{class:W(["w-full flex justify-between my-1 py-1 rounded-sm",t.role==="human"?"flex-row bg-green-200":"flex-row-reverse bg-blue-200"])},[u("div",{class:W(["font-medium flex-grow",{"bg-red-200":N.value===x}])},[N.value!==x?(s(),i("div",{key:0,class:W(["mx-2 whitespace-pre-wrap",t.role==="human"?"":"mr-8"]),msgId:t.id,onDblclick:L=>Ce(x),innerHTML:t.display_content?t.display_content:t.content},null,42,et)):B((s(),i("textarea",{key:1,"onUpdate:modelValue":L=>t.content=L,onBlur:o[0]||(o[0]=L=>N.value=-1),class:"w-full"},null,40,tt)),[[Ve,t.content],[Me]])],2),u("div",{class:W(["relative w-24 shrink-0 flex items-center box-border",t.role==="human"?"flex-row-reverse mr-8":"flex-row"])},[t.role==="human"?(s(),i("div",lt,[n(De)])):(s(),i("div",ot,[n(Be)])),u("div",nt,[u("span",st,q(t.role),1)])],2)],2),n(r,{size:"small",class:"hover:scale-110 absolute right-0 top-3",onClick:L=>xe(t.id),type:"danger",icon:"Delete",circle:""},null,8,["onClick"])]))),128))]),u("div",at,[n(k,{modelValue:p(a).question,"onUpdate:modelValue":o[1]||(o[1]=t=>p(a).question=t),autosize:"",type:"textarea",placeholder:"请输入或双击对话修改,Shift+enter提交",onKeyup:Se(Oe(le,["shift"]),["enter"])},null,8,["modelValue","onKeyup"]),n(r,{type:"success",onClick:le,title:"shift+enter提交"},{default:v(()=>[b("新增")]),_:1})])]),u("div",ut,[it,u("div",rt,[u("div",null,[ct,n(K,{modelValue:p(d),"onUpdate:modelValue":o[2]||(o[2]=t=>Te(d)?d.value=t:null),placeholder:"Select",style:{width:"100px"}},{default:v(()=>[(s(!0),i(C,null,V(ee.value,(t,x)=>(s(),Ne(R,{key:t.name,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),n(oe,{class:"w-full"},{default:v(()=>[n(r,{type:p(a).question_type==="human"?"primary":"success",round:"",onClick:p(M)},{default:v(()=>[b("Human")]),_:1},8,["type","onClick"]),n(r,{type:p(a).question_type==="gpt"?"primary":"success",round:"",onClick:p(J)},{default:v(()=>[b("gpt")]),_:1},8,["type","onClick"]),n(r,{type:p(a).question_type==="function_call"?"primary":"success",round:"",onClick:p(H)},{default:v(()=>[b("function_call")]),_:1},8,["type","onClick"]),n(r,{type:p(a).question_type==="observation"?"primary":"success",round:"",onClick:se},{default:v(()=>[b("observation")]),_:1},8,["type"])]),_:1}),n(oe,null,{default:v(()=>[n(r,{type:"danger",round:"",onClick:ue},{default:v(()=>[b("sample")]),_:1}),n(r,{type:"warning",round:"",onClick:me},{default:v(()=>[b("clear")]),_:1}),n(r,{type:"danger",round:"",onClick:ke},{default:v(()=>[b("save")]),_:1}),n(r,{type:"warning",round:"",onClick:ge},{default:v(()=>[b("auto")]),_:1})]),_:1}),n(oe,{class:"w-full"},{default:v(()=>[u("button",{class:"btn",onClick:P,disabled:he.value},[G.value?(s(),i("span",vt)):U("",!0),b(" answer ")],8,dt),n($e,{style:{"align-self":"center"},onClick:o[3]||(o[3]=t=>F.value=!F.value)},{default:v(()=>[n(qe)]),_:1}),B(u("div",null,[(s(!0),i(C,null,V(te.value,(t,x)=>(s(),i("div",{class:"inline-flex items-center",key:t},[u("label",{class:"relative flex cursor-pointer items-center rounded-full p-3",for:t,"data-ripple-dark":"true"},[B(u("input",{id:t,type:"checkbox","onUpdate:modelValue":o[4]||(o[4]=L=>D.value=L),value:t,class:"before:content[''] peer relative h-5 w-5 cursor-pointer appearance-none rounded-md border border-blue-gray-200 transition-all before:absolute before:top-2/4 before:left-2/4 before:block before:h-12 before:w-12 before:-translate-y-2/4 before:-translate-x-2/4 before:rounded-full before:bg-blue-gray-500 before:opacity-0 before:transition-opacity checked:border-pink-500 checked:bg-pink-500 checked:before:bg-pink-500 hover:before:opacity-10"},null,8,ft),[[Re,D.value]]),_t],8,pt),u("label",{class:"mt-px cursor-pointer select-none font-light text-gray-700",for:t},q(t),9,mt)]))),128))],512),[[X,F.value]])]),_:1})]),p(a).question_type==="function_call"?(s(),i("div",gt,[n(ne),n(We)])):U("",!0),fe.value?(s(),i("div",ht,[n(ne),u("div",yt,[(s(!0),i(C,null,V(p(g),(t,x)=>B((s(),i("div",{class:"card-body btn my-2",onClick:ae},q(t.name)+" --> "+q(t.msg),513)),[[X,p(g).length!==0]])),256))])])):U("",!0),I.value?(s(),i("div",bt,[n(ne),u("div",null,[(s(!0),i(C,null,V(p(O),t=>(s(),i("div",{class:"card w-full bg-base-300 shadow-xl mb-5",key:t.llm},[u("div",wt,[u("h3",kt,q(t.llm),1),B(u("button",{class:"btn btn-outline btn-success h-full",onClick:x=>ye(t.response.content)},q(t.response.content),9,xt),[[X,t.response.tool_calls.length===0]]),B(u("div",null,[(s(!0),i(C,null,V(t.response.tool_calls,x=>(s(),i("button",{class:"btn btn-outline btn-success h-full",onClick:L=>be(x)},q(x),9,Ct))),256))],512),[[X,t.response.tool_calls.length!==0]])])]))),128))])])):U("",!0),n(Ue),n(Ee)])])],64)}}});export{Ft as default};
