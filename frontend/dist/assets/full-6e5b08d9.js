import{d as se,g as r,Y as oe,y as ae,k as ne,h as le,T as ce,o as d,b as p,a as s,t as h,A as re,P as ie,F as N,e as I,p as R,n as ue,z as de,E as _,K as pe,q as ve,s as fe,_ as me}from"./index-f50d6d08.js";import{a as ye}from"./axios-a342f982.js";const k=A=>(ve("data-v-d38360ba"),A=A(),fe(),A),ge={class:"min-h-screen bg-gray-900"},he={class:"bg-gray-800 p-4 flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0"},_e=k(()=>s("div",{class:"flex items-center justify-center sm:justify-start space-x-4"},[s("h1",{class:"text-xl font-bold text-white"},"Voice Agent")],-1)),be={class:"text-white text-lg font-semibold text-center sm:text-left"},xe={class:"flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-4 sm:space-y-0"},we={class:"flex items-center justify-center sm:justify-start space-x-2"},ke=k(()=>s("label",{for:"voice-select",class:"text-white text-sm"},"声音选择:",-1)),Ae=["disabled"],De=["value"],Se={class:"container mx-auto p-4"},Ce={class:"grid grid-cols-1 sm:grid-cols-2 gap-4"},$e={class:"flex flex-col space-y-4"},Be={class:"bg-gray-800 rounded-lg p-4"},Me=k(()=>s("h2",{class:"text-xl mb-4 text-white"},"Agent",-1)),Ne={class:"mt-8"},Ie={class:"bg-gray-700 p-4 rounded-lg"},Pe=k(()=>s("div",{class:"flex items-center space-x-2"},[s("span",{class:"bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm"},"MICROPHONE"),s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-blue-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"})])],-1)),Ue={key:0,class:"waveform-container mt-4"},Ve=k(()=>s("h2",{class:"text-xl mb-4 text-white"},"日志",-1)),Ee={class:"flex items-baseline space-x-2"},Re={class:"text-xs text-gray-500"},Te={class:"bg-gray-100 rounded-lg p-3 mt-1 max-w-[80%] break-words"},je={class:"bg-gray-800 rounded-lg p-4"},qe={class:"h-[600px] overflow-y-auto"},ze=se({__name:"full",setup(A){const D="https://ai.minitool.fun:15401",O=D.replace("https://","wss://").replace("http://","ws://"),F=r("property management service"),v=r(!1),f=r(!1),S=r(!1),T=r(!0),m=r([]);m.value.push({type:"system",content:"欢迎使用实时访谈系统,点击Connect开始。",timestamp:new Date});const C=r(null),P=r(null),b=r([]),U=r(Array(20).fill(5));let u=null,x=null,y=null,$=null;const w=r("amuch"),B=r(["amuch","dan"]),i=r(null);let g=null;const V=[];let E=!1;const j=oe(),L=ae(()=>j.query.outlineid?Number(j.query.outlineid):1),q=async()=>{_({title:"开始收音",message:"收音中",type:"info"});try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});u=new(window.AudioContext||window.webkitAudioContext),x=u.createMediaStreamSource(t),y=u.createAnalyser(),y.fftSize=64,$=new Uint8Array(y.frequencyBinCount),g=u.createScriptProcessor(4096,1,1),x.connect(y),x.connect(g),g.connect(u.destination),g.onaudioprocess=K,f.value=!0,W()}catch(t){console.error("Error accessing microphone:",t),b.value.push({type:"system",content:"访问麦克风出错。请检查权限设置。",timestamp:new Date})}},J=t=>{const a=new ArrayBuffer(t.length*2),e=new DataView(a);for(let o=0;o<t.length;o++){const n=Math.max(-1,Math.min(1,t[o]));e.setInt16(o*2,n<0?n*32768:n*32767,!0)}return a},G=t=>{const a=J(t),e=new Uint8Array(a);let o="";const n=32768;for(let l=0;l<e.length;l+=n){const c=e.subarray(l,l+n);o+=String.fromCharCode.apply(null,Array.from(c))}return btoa(o)},K=t=>{const a=t.inputBuffer.getChannelData(0),o=Math.max(...a.map(Math.abs))*100;console.log(`音量: ${o}`);const n=G(a);Q(n)},Q=t=>{if(i.value&&i.value.readyState===WebSocket.OPEN){const a={event:"media",media:{payload:t}};i.value.send(JSON.stringify(a)),console.log(`${new Date}:发送了音频数据到后台`)}},z=()=>{x&&y&&(_({title:"停止收音",message:"收音结束",type:"info"}),x.disconnect(),y.disconnect(),g&&(g.disconnect(),g.onaudioprocess=null),f.value=!1)},Y=()=>{var t;v.value?((t=i.value)==null||t.close(),v.value=!1,f.value=!1,z()):X()},X=()=>{m.value=[],b.value=[];const t="chikka";try{i.value=new WebSocket(`${O}/ws/voice-stream/${t}?voice=${w.value}&outline_id=${L.value}`),i.value.onerror=()=>{_({title:"错误",message:"WebSocket连接失败，服务器可能未启动或网络有问题。",type:"error",duration:5e3}),v.value=!1,f.value=!1}}catch(a){_({title:"异常",message:`创建WebSocket时发生错误，后台服务器没启动：${a.message}`,type:"error",duration:5e3}),v.value=!1,f.value=!1}i.value.onopen=()=>{v.value=!0,b.value.push({type:"system",content:"连接后台成功",timestamp:new Date}),console.log(`${new Date}:连接后台成功`),q()},i.value.onmessage=a=>{var o,n,l;const e=JSON.parse(a.data);if(e.event==="media")console.log(`${new Date}:收到了后台语音数据`),V.push(e.media.payload),E||H();else if(e.event==="message"){console.log(e);let c=e.response.type;if(e.response.type==="response.audio.delta"?c=c+": 音频子节长度"+e.response.delta.length:c=c+": "+e.response.delta,console.log(`${new Date}:content`),((o=e.response)==null?void 0:o.type)==="response.audio_transcript.delta"){const M=e.response.delta;f.value&&(z(),f.value=!1,console.log(`${new Date}:已停止录音，后台正在处理数据。`)),!S.value||m.value.length===0?(S.value=!0,m.value.push({type:"sent",content:"用户声音消息...",timestamp:new Date}),m.value.push({type:"received",content:M,timestamp:new Date})):m.value[m.value.length-1].content+=M}if(((n=e.response)==null?void 0:n.type)==="response.audio_transcript.done"&&(T.value=!0),((l=e.response)==null?void 0:l.type)==="conversation.item.input_audio_transcription.completed"){const M=e.response.transcript;m.value.push({type:"sent",content:`转录结果: ${M}`,timestamp:new Date})}}ee()},i.value.onclose=()=>{v.value=!1,b.value.push({type:"system",content:"Disconnected from server",timestamp:new Date})}},W=()=>{if(y&&$){y.getByteFrequencyData($);for(let t=0;t<U.value.length;t++)U.value[t]=($[t]||0)/2;f.value&&requestAnimationFrame(W)}},H=()=>{if(V.length>0){const t=V.shift();t&&(Z(t,()=>{E=!1,H()}),E=!0)}else S.value=!1};ne([S,T],([t,a])=>{!t&&a&&q()});const Z=(t,a)=>{const e=Uint8Array.from(atob(t),c=>c.charCodeAt(0)),o=u.createBuffer(1,e.length/2,44100),n=new Int16Array(e.buffer);for(let c=0;c<n.length;c++)o.getChannelData(0)[c]=n[c]/32768;const l=u.createBufferSource();l.buffer=o,l.connect(u.destination),l.playbackRate.value=.6,l.onended=a,l.start()},ee=async()=>{await pe(),P.value&&(P.value.scrollTop=P.value.scrollHeight),C.value&&(C.value.scrollTop=C.value.scrollHeight)};async function te(){try{const t=await ye.get(`${D}/api/voice`);t.data.length>0?(console.log(`连接服务器成功，获取到的数据是: ${t.data}`),B.value=t.data,B.value.includes(w.value)||(w.value=B.value[0])):_({title:"服务器没有返回Pong",message:`请联系管理员检查服务器地址${D}`,type:"error"})}catch(t){_({title:"连接服务器失败",message:`请检查网络连接${D},${t}`,type:"error"})}}return le(async()=>{await te()}),ce(()=>{i.value&&i.value.close(),u&&u.close()}),(t,a)=>(d(),p("div",ge,[s("header",he,[_e,s("div",be," 访谈主题: "+h(F.value),1),s("div",xe,[s("div",we,[ke,re(s("select",{id:"voice-select","onUpdate:modelValue":a[0]||(a[0]=e=>w.value=e),disabled:v.value,class:"px-3 py-2 rounded-lg bg-gray-300 text-gray-800 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 hover:shadow-md"},[(d(!0),p(N,null,I(B.value,e=>(d(),p("option",{key:e,value:e},h(e),9,De))),128))],8,Ae),[[ie,w.value]])]),s("button",{onClick:Y,class:R(["px-4 py-2 rounded-lg font-medium",v.value?"bg-red-600 hover:bg-red-700":"bg-blue-600 hover:bg-blue-700","text-white"])},h(v.value?"Disconnect":"Connect"),3)])]),s("div",Se,[s("div",Ce,[s("div",$e,[s("div",Be,[Me,s("div",Ne,[s("div",Ie,[Pe,f.value?(d(),p("div",Ue,[(d(!0),p(N,null,I(U.value,(e,o)=>(d(),p("div",{key:o,style:ue({height:`${e}px`}),class:"waveform-bar"},null,4))),128))])):de("",!0)])])]),s("div",{ref_key:"logContainer",ref:C,class:"sm:flex-1 overflow-y-auto p-4 space-y-4",style:{"max-height":"calc(100vh - 8rem)"}},[Ve,(d(!0),p(N,null,I(b.value,(e,o)=>{var n;return d(),p("div",{key:o,class:"flex flex-col"},[s("div",Ee,[s("span",{class:R(["font-bold",{"bg-yellow-600":e.type==="system","bg-blue-600":e.type==="sent","bg-green-600":e.type==="received"}])},h(e.type),3),s("span",Re,h((n=e.timestamp)==null?void 0:n.toLocaleTimeString()),1)]),s("div",Te,h(e.content),1)])}),128))],512)]),s("div",je,[s("div",qe,[(d(!0),p(N,null,I(m.value,(e,o)=>(d(),p("div",{key:o,class:R(["mb-4 p-2 rounded",{"bg-yellow-600":e.type==="system","bg-blue-600":e.type==="sent","bg-green-600":e.type==="received"}])},h(e.content),3))),128))])])])])]))}});const Oe=me(ze,[["__scopeId","data-v-d38360ba"]]);export{Oe as default};
