import{d as Ce,L as X,g as h,y as Y,h as $e,r as V,$ as qe,o as r,b as d,f as v,a as s,F as q,e as A,p as D,A as k,C as S,t as U,i as b,D as je,G as Ve,w,j,c as Ae,O as Me,z as O,B as G,E as x}from"./index-f50d6d08.js";import{u as Z,a as Se,_ as Ue}from"./navHeader.vue_vue_type_script_setup_true_lang-5f81fcc5.js";import{_ as Ee,a as Re,b as Te}from"./functionDrawer.vue_vue_type_script_setup_true_lang-34bd2630.js";import{a as De}from"./axios-a342f982.js";import{g as Be,a as Ne,b as Fe,s as Ie}from"./api-e233926e.js";const Le={class:"w-screen flex mx-auto my-0 p-2"},Pe={class:"left h-screen w-1/2 rounded"},Oe={class:"w-full h-full overflow-auto border-r-2 border-gray-300 rounded-sm"},Ge=["msgId","onDblclick","innerHTML"],He=["onUpdate:modelValue"],ze={key:0,class:"w-6 h-6 mt-1"},Qe={key:1,class:"w-6 h-6 mt-1"},Ke={class:"text-ellipsis overflow-hidden w-full text-center leading-4"},Je={class:"text-sm leading-4"},We={class:"flex w-full h-12 grow"},Xe={class:"right bg-white w-1/2"},Ye=s("div",{class:"text-center mb-2"},"点击任何按钮生成对应的对话 ",-1),Ze={class:"flex justify-between items-center flex-wrap w-4/5"},et=s("span",null,"prompt:",-1),tt={key:0},lt={key:1},st={class:"card-body p-6"},nt={class:"card-title"},ot=["onClick"],at=["onClick"],ut={key:2},it=["onMouseover","onMouseleave"],ct={class:"input input-bordered w-32"},rt=["onUpdate:modelValue"],dt={class:"input input-bordered w-32"},vt=["onUpdate:modelValue"],pt={class:"input input-bordered w-32"},_t=["onUpdate:modelValue"],gt={class:"w-full"},ht=s("label",{for:"default-search",class:"mb-2 text-sm font-medium text-gray-900 sr-only dark:text-gray-300"},"Search",-1),ft={class:"relative w-full"},mt=["onUpdate:modelValue","onInput"],yt={class:"dropdown-menu"},bt={class:"bg-white rounded-lg shadow-xl px-4 relative mt-2"},wt=["onClick"],xt={href:"#",class:"flex-1"},kt={class:"text-gray-600 text-base"},Ct=s("div",null,[s("svg",{width:"40",height:"20",viewBox:"0 0 40 20",xmlns:"http://www.w3.org/2000/svg"},[s("line",{x1:"30",y1:"2",x2:"40",y2:"10",stroke:"#9CA3AF"}),s("line",{x1:"30",y1:"18",x2:"40",y2:"10",stroke:"#9CA3AF"}),s("line",{x1:"20",y1:"10",x2:"40",y2:"10",stroke:"#9CA3AF"})])],-1),$t=["onClick"],qt=["onClick"],Nt=Ce({__name:"labelsentiment",setup(jt){const{currentQuestion:i,messages:e,function_result:Vt,message_tool_names:ee,tools_data:B,multi_llm_results:N}=X(Z()),{selectedLLM:At,sample_idx:C,selectedSample:E,usecache:Mt,currentPrompt:R}=X(Se()),{AddHumanMsg:te,AddGptMsg:le,AddFunctionMsg:St,AddObservationMsg:Ut}=Z(),T=h(-1);Y(()=>i.value.question_type==="observation"||i.value.question_type==="function_call");const F=h(),se=h(!1),H=h(),ne=h([]),M=h(),I=h(!1);h(!1);const $=h(!1),oe=h(!0),_=h([]),ae=h(["积极","消极","中性"]),L=h(-1),ue="https://ai.minitool.fun:6677",ie={正向:"积极",负向:"消极",中性:"中性"};async function ce(l,n,o){try{return(await De.post(ue+"/food_sentiment/predict",{content:l,keyword:n,...o})).data.data}catch(c){console.log(c),x({title:"Error",message:"处理请求情感接口失败"})}}async function z(){console.log("rule_answers: ",_.value);const l=e.value[e.value.length-1].role;let n;l==="human"?n=e.value.length-1:n=e.value.length-2;let o=e.value[n].content;o=o.split("-->")[0];const f=_.value.map(p=>p.subject),m=Array.from(new Set(f));for(let p of m){const y=_.value.filter(a=>a.subject===p);let g={};for(let a of y)a.relation in g?g[a.relation].push(a.guest):g[a.relation]=[a.guest];const t=await ce(o,p,g);console.log("情感识别结果:",t);for(let a in t)for(let u of g[a]){const J=t[a][u].sentiment,ke=ie[J],W=_.value.findIndex(P=>P.subject===p&&P.relation===a&&P.guest===u);W!==-1&&(_.value[W].sentiment=ke)}}}function re(l){console.log("高亮规则回答:",l);const n=e.value[e.value.length-1].role;let o;n==="human"?o=e.value.length-1:o=e.value.length-2;let c=e.value[o].content;c=c.replace("-->",`
-->`),c=c.replace("评论是",`
评论是`);const f=l.subject,m=l.guest,p=new RegExp(f,"g"),g=`<span style="background-color: red;">${f}</span>`;c=c.replace(p,g);const t=new RegExp(m,"g"),u=`<span style="background-color: yellow;">${m}</span>`;c=c.replace(t,u),e.value[o].display_content=c}function de(l){console.log("移除规则回答的高亮:",l);const n=e.value[e.value.length-1].role;let o;n==="human"?o=e.value.length-1:o=e.value.length-2,e.value[o].display_content=""}function ve(l){_.value.splice(l,1)}function pe(l){const n=_.value[l];if(e.value[e.value.length-1].role==="gpt"){const c=e.value[e.value.length-1].content,f=`(${n.subject}, ${n.relation}, ${n.guest}, ${n.sentiment})`,m=`${c}
${f}`;e.value[e.value.length-1].content=m}else{const c=`(${n.subject}, ${n.relation}, ${n.guest}, ${n.sentiment})`;e.value.push({id:e.value[e.value.length-1].id+1,role:"gpt",content:c})}_.value.splice(l,1)}function Q(){_.value=[];const l=e.value[e.value.length-1].content;if(l.includes("主体是")&&l.includes("关系和客体包括")){var n=l.split("-->");console.log("切分出的内容: ",n);var o=n[1].split("主体是:")[1];const m=o.split(",");console.log("subject: ",m);var c=n[2].split("关系和客体包括:")[1],f=JSON.parse(c);console.log("relations_object: ",f);for(let p in f){const y=f[p];p.includes(",")?p.split(",").forEach(g=>{m.forEach(t=>{const a={subject:t,relation:y,guest:g,sentiment:"积极"};console.log("one_rule_answer: ",a),_.value.push(a)})}):m.forEach(g=>{const t={subject:g,relation:y,guest:p,sentiment:"积极"};console.log("one_rule_answer: ",t),_.value.push(t)})}_.value.sort((p,y)=>p.subject.localeCompare(y.subject))}}function _e(){e.value[e.value.length-1].role==="gpt"?e.value[e.value.length-1].content="无":e.value.push({id:e.value[e.value.length-1].id+1,role:"gpt",content:"无"})}function ge(){e.value=[],i.value.question="",i.value.question_id=-1,i.value.question_type="",$.value&&(C.value+=1),$.value=!1}Y(()=>e.value.length===0||e.value[e.value.length-1].role==="gpt");function he(l){e.value.push({id:e.value[e.value.length-1].id+1,role:"gpt",content:l}),I.value=!1,N.value=[]}function fe(l){const n=JSON.stringify(l);e.value.push({id:e.value[e.value.length-1].id+1,role:"function_call",content:n}),I.value=!1,N.value=[]}function me(){H.value.includes(E.value)&&(ne.value.push(E.value),se.value=!0)}async function ye(){if(M.value||x.info("你还没有在管理界面设置Sample问题类型，请先进行设置后，在使用sample按钮"),$.value=!0,C.value<=M.value.length){const l=M.value[C.value];me(),e.value.length===0?(e.value.push({id:1,role:"human",content:l}),Q(),await z()):e.value[e.value.length-1].role==="gpt"?(e.value.push({id:e.value[e.value.length-1].id+1,role:"human",content:l}),Q(),await z()):x.warning("上一条消息不是gpt，或者不是第一条信息，无法添加human的问题")}else x.warning("没有更多的的样本了,请在管理中设置样本数据集和样本的起始序号")}async function be(){const l=await Ie({messages:e.value,prompt:R.value,tools:ee.value});console.log("数据的保存结果:",l),l.code===0?(x({message:"保存数据成功到后台",type:"info"}),e.value=[],i.value.question="",i.value.question_id=-1,i.value.question_type="",$.value&&(C.value+=1),$.value=!1):x({message:"保存数据失败，请检查后端日志",type:"error"})}function we(l){if(l!==-1){console.log("要删除message:",l);let n=e.value.filter(o=>o.id!==l);e.value=n,$.value&&e.value.length===0&&(C.value+=1),$.value=!1}else x({message:"没有选中任何信息，请双击1条信息，然后按delete键删除",type:"info"})}function xe(l){e.value.forEach((n,o)=>{o===l&&(i.value.question_type=n.role,T.value=l)})}function K(){if(i.value.question_id===-1&&e.value.length===0)e.value.push({id:1,role:"human",content:i.value.question});else{if(!i.value.question_type){x({message:"还没有选择当前消息的类型，请右边点击按钮选择类型",type:"info"});return}if(!i.value.question){x({message:"你好像还么有输入任何內",type:"info"});return}const l=e.value[e.value.length-1].role;if(i.value.question_type===l){x({message:"不能连续2条都是同1个角色的消息",type:"info"});return}e.value.push({id:e.value[e.value.length-1].id+1,role:i.value.question_type,content:i.value.question})}i.value.question="",i.value.question_id=-1,i.value.question_type=""}return $e(async()=>{const l=await Be();F.value=l.data,console.log("prompts:",F.value);const n=await Ne();B.value=n.data,console.log("tools_data:",B.value),H.value=Object.keys(B.value);const o=await Fe({keyword:E.value});console.log(o),o.data.forEach(c=>{c.prompt===E.value&&(M.value=c.questions)}),console.log(M.value),C.value=+C.value}),(l,n)=>{const o=V("el-button"),c=V("el-input"),f=V("el-option"),m=V("el-select"),p=V("el-row"),y=V("el-divider"),g=qe("autogrow");return r(),d(q,null,[v(Ue),s("main",Le,[s("div",Pe,[s("div",Oe,[(r(!0),d(q,null,A(b(e),(t,a)=>(r(),d("div",{class:"leading-6 flex justify-between content-center relative grow",key:t.id},[s("div",{class:D(["w-full flex justify-between my-1 py-1 rounded-sm",t.role==="human"?"flex-row bg-green-200":"flex-row-reverse bg-blue-200"])},[s("div",{class:D(["font-medium flex-grow",{"bg-red-200":T.value===a}])},[T.value!==a?(r(),d("div",{key:0,class:D(["mx-2 whitespace-pre-wrap",t.role==="human"?"":"mr-8"]),msgId:t.id,onDblclick:u=>xe(a),innerHTML:t.display_content?t.display_content:t.content},null,42,Ge)):k((r(),d("textarea",{key:1,"onUpdate:modelValue":u=>t.content=u,onBlur:n[0]||(n[0]=u=>T.value=-1),class:"w-full"},null,40,He)),[[S,t.content],[g]])],2),s("div",{class:D(["relative w-24 shrink-0 flex items-center box-border",t.role==="human"?"flex-row-reverse mr-8":"flex-row"])},[t.role==="human"?(r(),d("div",ze,[v(Ee)])):(r(),d("div",Qe,[v(Re)])),s("div",Ke,[s("span",Je,U(t.role),1)])],2)],2),v(o,{size:"small",class:"hover:scale-110 absolute right-0 top-3",onClick:u=>we(t.id),type:"danger",icon:"Delete",circle:""},null,8,["onClick"])]))),128))]),s("div",We,[v(c,{modelValue:b(i).question,"onUpdate:modelValue":n[1]||(n[1]=t=>b(i).question=t),autosize:"",type:"textarea",placeholder:"请输入或双击对话修改,Shift+enter提交",onKeyup:je(Ve(K,["shift"]),["enter"])},null,8,["modelValue","onKeyup"]),v(o,{type:"success",onClick:K,title:"shift+enter提交"},{default:w(()=>[j("新增")]),_:1})])]),s("div",Xe,[Ye,s("div",Ze,[s("div",null,[et,v(m,{modelValue:b(R),"onUpdate:modelValue":n[2]||(n[2]=t=>Me(R)?R.value=t:null),placeholder:"Select",style:{width:"100px"}},{default:w(()=>[(r(!0),d(q,null,A(F.value,(t,a)=>(r(),Ae(f,{key:t.name,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),v(p,{class:"w-full"},{default:w(()=>[v(o,{type:b(i).question_type==="human"?"primary":"success",round:"",onClick:b(te)},{default:w(()=>[j("Human")]),_:1},8,["type","onClick"]),v(o,{type:b(i).question_type==="gpt"?"primary":"success",round:"",onClick:b(le)},{default:w(()=>[j("gpt")]),_:1},8,["type","onClick"])]),_:1}),v(p,null,{default:w(()=>[v(o,{type:"danger",round:"",onClick:ye},{default:w(()=>[j("sample")]),_:1}),v(o,{type:"warning",round:"",onClick:ge},{default:w(()=>[j("clear")]),_:1}),v(o,{type:"danger",round:"",onClick:be},{default:w(()=>[j("save")]),_:1}),v(o,{type:"warning",round:"",onClick:_e},{default:w(()=>[j("none")]),_:1})]),_:1})]),b(i).question_type==="function_call"?(r(),d("div",tt,[v(y),v(Te)])):O("",!0),I.value?(r(),d("div",lt,[v(y),s("div",null,[(r(!0),d(q,null,A(b(N),t=>(r(),d("div",{class:"card w-full bg-base-300 shadow-xl mb-5",key:t.llm},[s("div",st,[s("h3",nt,U(t.llm),1),k(s("button",{class:"btn btn-outline btn-success h-full",onClick:a=>he(t.response.content)},U(t.response.content),9,ot),[[G,t.response.tool_calls.length===0]]),k(s("div",null,[(r(!0),d(q,null,A(t.response.tool_calls,a=>(r(),d("button",{class:"btn btn-outline btn-success h-full",onClick:u=>fe(a)},U(a),9,at))),256))],512),[[G,t.response.tool_calls.length!==0]])])]))),128))])])):O("",!0),oe.value?(r(),d("div",ut,[(r(!0),d(q,null,A(_.value,(t,a)=>(r(),d("div",{class:"flex items-center gap-2 flex-row mt-4 hover:border hover:border-pink-700",onMouseover:u=>re(t),onMouseleave:u=>de(t)},[s("label",ct,[k(s("input",{type:"text",class:"grow",placeholder:"主体","onUpdate:modelValue":u=>t.subject=u},null,8,rt),[[S,t.subject]])]),s("label",dt,[k(s("input",{type:"text",class:"grow",placeholder:"类型","onUpdate:modelValue":u=>t.relation=u},null,8,vt),[[S,t.relation]])]),s("label",pt,[k(s("input",{type:"text",class:"grow",placeholder:"客体","onUpdate:modelValue":u=>t.guest=u},null,8,_t),[[S,t.guest]])]),s("form",gt,[ht,s("div",ft,[k(s("input",{type:"search",id:"default-search","onUpdate:modelValue":u=>t.sentiment=u,onInput:u=>L.value=a,class:"block p-4 pl-4 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500",placeholder:"prompt",required:""},null,40,mt),[[S,t.sentiment]])]),k(s("div",yt,[(r(!0),d(q,null,A(ae.value,u=>(r(),d("div",bt,[s("div",{class:"py-4 flex items-center w-full hover:bg-gray-50",onClick:J=>{t.sentiment=u,L.value=-1}},[s("a",xt,[s("div",kt,U(u),1)]),Ct],8,wt)]))),256))],512),[[G,L.value===a]])]),s("button",{class:"btn btn-success",onClick:u=>pe(a)},"添加",8,$t),s("button",{class:"btn btn-warning",onClick:u=>ve(a)},"删除",8,qt)],40,it))),256))])):O("",!0)])])],64)}}});export{Nt as default};
